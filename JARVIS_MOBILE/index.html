<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050a14">
    <meta name="mobile-web-app-capable" content="yes">
    <title>JARVIS: MOBILE UNIT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* --- CORE STYLES --- */
        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; }
        html { background: #050a14; height: 100%; }
        body { margin: 0; overflow: hidden; background-color: #050a14; font-family: 'Orbitron', sans-serif; color: #00E5FF; height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; touch-action: none; }
        
        /* REACTOR CONTAINER */
        #reactor-container { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 100vw; height: 100vh; z-index: 0; opacity: 0.8; background: radial-gradient(circle, rgba(0,0,0,0) 20%, rgba(5, 10, 20, 0.4) 100%); pointer-events: none; }
        canvas { display: block; }
        
        /* CORE VISION OVERLAY (The Eye) */
        #core-vision-overlay {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            border-radius: 50%;
            overflow: hidden;
            z-index: 5; /* Above canvas, below UI */
            display: none; /* Hidden by default */
            background: #000;
            border: 2px solid #00E5FF;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
            pointer-events: auto;
            cursor: pointer;
        }
        #core-vision-overlay img, #core-vision-overlay video {
            width: 100%; height: 100%; object-fit: cover;
        }
        #core-loading {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 10px; color: #00E5FF; text-align: center; width: 100%;
            pointer-events: none;
        }

        /* STATUS OVERLAYS */
        #overlay-text { position: absolute; bottom: 15px; width: 100%; text-align: center; color: #00bcd4; font-size: 10px; opacity: 0.6; z-index: 2; pointer-events: none; }
        #mic-status { position: absolute; top: 20px; width: 100%; text-align: center; color: rgba(0, 229, 255, 0.7); font-size: 12px; letter-spacing: 3px; z-index: 2; font-weight: 700; pointer-events: none; }
        
        /* INIT OVERLAY - FIX: Ensure it captures clicks */
        #start-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(5, 10, 20, 0.95); 
            z-index: 9999; /* Topmost */
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            cursor: pointer; 
            pointer-events: auto; /* Critical for interactivity */
        }
        #start-btn { padding: 20px 40px; border: 2px solid #00E5FF; background: rgba(0, 229, 255, 0.1); color: #00E5FF; font-family: 'Orbitron'; font-size: 20px; font-weight: 900; letter-spacing: 2px; pointer-events: auto; box-shadow: 0 0 30px rgba(0, 229, 255, 0.2); }

        /* --- STANDARD WINDOWS (Rectangular) --- */
        .modal-window { 
            position: absolute; background: rgba(10, 15, 25, 0.95); border: 1px solid #00E5FF; 
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.15); backdrop-filter: blur(15px); padding: 0; 
            display: none; flex-direction: column; z-index: 20; pointer-events: auto;
            width: 350px; height: 400px; min-width: 200px; min-height: 200px;
        }
        .modal-header { background: rgba(0, 229, 255, 0.15); padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #00E5FF; flex-shrink: 0; cursor: grab; touch-action: none; }
        .modal-header:active { cursor: grabbing; background: rgba(0, 229, 255, 0.25); }
        .modal-title { font-size: 14px; font-weight: bold; text-shadow: 0 0 5px #00E5FF; pointer-events: none; }
        .close-btn { font-size: 24px; padding: 0 10px; color: #00E5FF; cursor: pointer; z-index: 30; pointer-events: auto; }
        .modal-body { flex: 1; padding: 15px; overflow-y: auto; color: #ccc; display: flex; flex-direction: column; gap: 10px; position: relative; }

        /* RESIZE HANDLE */
        .resize-handle {
            position: absolute; bottom: 0; right: 0; width: 20px; height: 20px;
            background: linear-gradient(135deg, transparent 50%, #00E5FF 50%);
            cursor: nwse-resize; z-index: 30; touch-action: none;
        }

        /* INPUTS & BUTTONS */
        .input-group { display: flex; gap: 5px; flex-shrink: 0; }
        input[type="text"], select { background: rgba(0, 20, 30, 0.9); border: 1px solid #00E5FF; color: #00E5FF; padding: 10px; flex: 1; outline: none; font-family: 'Orbitron'; font-size: 16px; min-height: 40px; pointer-events: auto; }
        button { background: rgba(0, 229, 255, 0.1); color: #00E5FF; border: 1px solid #00E5FF; padding: 10px; font-family: 'Orbitron'; cursor: pointer; min-height: 44px; transition: 0.2s; pointer-events: auto; }
        button:hover { background: #00E5FF; color: #000; box-shadow: 0 0 15px #00E5FF; }
        
        /* LAYOUTS */
        .split-view { display: flex; flex-direction: column; width: 100%; height: 100%; gap: 10px; flex: 1; min-height: 0; }
        .panel { flex: 1; background: rgba(0, 0, 0, 0.4); border: 1px solid rgba(0, 229, 255, 0.3); padding: 10px; display: flex; flex-direction: column; min-height: 0; }
        .chat-log { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 12px; line-height: 1.4; font-family: 'Consolas', monospace; color: #aaa; }
        #code-editor { flex: 1; font-size: 10px; background: #0c121c; padding: 10px; overflow-y: auto; white-space: pre; min-height: 0; font-family: 'Consolas', monospace; border-left: 2px solid rgba(0,229,255,0.3); }

        /* DOT */
        .os-status-dot { width: 8px; height: 8px; border-radius: 50%; background: #555; display: inline-block; margin-right: 5px; box-shadow: 0 0 5px #555; }
        .os-active { background: #00E5FF; box-shadow: 0 0 8px #00E5FF; }
        
        /* MOBILE SPECIFIC */
        @media (max-width: 768px) {
            .modal-window {
                width: 95% !important; height: 85% !important;
                top: 50% !important; left: 50% !important;
                transform: translate(-50%, -50%) !important;
            }
        }
    </style>
</head>
<body>

    <div id="start-overlay" onclick="initSystem()">
        <div id="start-btn">INITIALIZE JARVIS</div>
        <div style="margin-top: 15px; opacity: 0.7; font-size: 10px;">CORE INTEGRATION v65.0</div>
    </div>

    <div id="reactor-container"><canvas id="reactor"></canvas></div>
    
    <!-- INTEGRATED CORE VISION -->
    <div id="core-vision-overlay" onclick="toggleCameraSource()" title="Click to Switch Camera">
        <img id="vision-feed" src="" style="display: block;" onerror="this.style.display='none'; document.getElementById('core-loading').style.display='block';">
        <video id="local-vision-feed" autoplay playsinline style="display: none;"></video>
        <div id="core-loading" style="display: none;">SIGNAL LOST</div>
    </div>

    <div id="mic-status">AWAITING INITIALIZATION</div>
    <div id="overlay-text">SYSTEM ONLINE</div>

    <!-- COMMAND CENTER -->
    <div id="modal-command" class="modal-window">
        <div class="modal-header" id="header-command">
            <span class="modal-title">MAIN CONSOLE</span>
            <span class="close-btn" onclick="closeModal('modal-command')">×</span>
        </div>
        <div class="modal-body">
            <div class="split-view">
                <div class="panel" style="flex: 2;"> 
                    <div class="chat-log" id="chat-log">> SYSTEM: CORE VISION ONLINE.<br>> SYSTEM: READY.<br></div>
                    <div class="input-group">
                        <input type="text" id="chat-input" placeholder="Command..." onkeydown="handleChat(event)">
                        <button onclick="toggleVoiceInput()"><i class="fas fa-microphone"></i></button>
                    </div>
                </div>
                <div class="panel" style="flex: 1;">
                    <div id="code-editor">// DATA STREAM...</div>
                </div>
            </div>
            <div class="resize-handle" id="resize-command"></div>
        </div>
    </div>

    <!-- MEDIA -->
    <div id="modal-media" class="modal-window">
        <div class="modal-header" id="header-media">
            <span class="modal-title">MEDIA LINK</span>
            <span class="close-btn" onclick="closeModal('modal-media')">×</span>
        </div>
        <div class="modal-body">
            <input type="file" id="media-upload" accept="audio/*" multiple onchange="handleMediaSelect(this)" style="display:none;">
            <button onclick="document.getElementById('media-upload').click()" style="width:100%">ADD SONGS</button>
            <div id="now-playing" style="margin-top:10px; color:#00E5FF;">NO MEDIA SELECTED</div>
            <audio id="audio-player" controls style="width: 100%; filter: invert(1) hue-rotate(180deg);"></audio>
            <div id="media-playlist" style="margin-top:20px; flex: 1; overflow-y: auto;"></div>
            <div class="resize-handle" id="resize-media"></div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="modal-settings" class="modal-window">
        <div class="modal-header" id="header-settings">
            <span class="modal-title">SYSTEM CONFIG</span>
            <span class="close-btn" onclick="closeModal('modal-settings')">×</span>
        </div>
        <div class="modal-body">
            <div class="setting-row"><span>GEMINI KEY</span><input type="password" id="api-key-input" onchange="saveApiKey(this.value)"></div>
            <div class="setting-row"><span>BRIDGE URL</span><input type="text" id="bridge-url-input" onchange="saveBridgeUrl(this.value)" placeholder="https://..."></div>
            <div class="setting-row"><span>VOICE</span><select id="voice-select" onchange="saveVoiceSelection(this)"></select></div>
            <div class="setting-row"><span>BRIDGE STATUS</span><span id="os-dot" class="os-status-dot"></span></div>
            <button onclick="testVoice()" style="width:100%; margin-top: auto;">TEST AUDIO</button>
            <div class="resize-handle" id="resize-settings"></div>
        </div>
    </div>

    <script>
        // --- CORE INIT & UTILS ---
        let wakeLock = null;
        async function requestWakeLock() {
            if ('wakeLock' in navigator) { try { wakeLock = await navigator.wakeLock.request('screen'); } catch (err) {} }
        }

        const canvas = document.getElementById('reactor');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, centerY, scale, time = 0;
        
        // State
        let userApiKey = "", customBridgeUrl = "";
        let systemState = 'IDLE', micEnabled = false;
        let batteryLevel = 1.0;
        let playlist = [], currentTrackIndex = 0, mediaDB = null;
        let voices = [], isSpeaking = false, isAwake = false, silenceTimer = null, recognition = null;
        let usingLocalCamera = false, localStream = null;
        let audioCtx, analyser, dataArray, audioPlayer;
        
        // VISION STATE
        let visionActive = false;

        const colors = { cyan: '#00E5FF', darkCyan: 'rgba(0, 229, 255, 0.15)', orange: '#FFA500', bg: '#050a14', white: '#FFFFFF' };
        const menuItems = [
            { id: 'med', label: 'MEDIA', icon: '\uf001', targetModal: 'modal-media', angle: -Math.PI * 0.75, opacity: 0.4, hovered: false }, 
            { id: 'set', label: 'CONFIG', icon: '\uf013', targetModal: 'modal-settings', angle: -Math.PI * 0.25, opacity: 0.4, hovered: false }, 
            { id: 'vis', label: 'VISION', icon: '\uf06e', targetModal: 'core-vision', angle: Math.PI * 0.25, opacity: 0.4, hovered: false },
            { id: 'cmd', label: 'HOME', icon: '\uf015', targetModal: 'modal-command', angle: Math.PI * 0.75, opacity: 0.4, hovered: false }
        ];

        // --- WINDOW MANAGEMENT ---
        function makeDraggable(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            const headerId = "header-" + elmnt.id.split('-')[1];
            const header = document.getElementById(headerId);
            
            if (header) {
                header.onmousedown = dragMouseDown;
                header.ontouchstart = dragTouchStart;
            }

            function dragMouseDown(e) { e = e || window.event; e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
            function dragTouchStart(e) { const touch = e.touches[0]; pos3 = touch.clientX; pos4 = touch.clientY; document.ontouchend = closeDragElement; document.ontouchmove = elementTouchDrag; }
            function elementDrag(e) { e = e || window.event; e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; elmnt.style.transform = "none"; }
            function elementTouchDrag(e) { const touch = e.touches[0]; pos1 = pos3 - touch.clientX; pos2 = pos4 - touch.clientY; pos3 = touch.clientX; pos4 = touch.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; elmnt.style.transform = "none"; }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; document.ontouchend = null; document.ontouchmove = null; }
        }

        function makeResizable(elmnt) {
            const resizer = document.getElementById("resize-" + elmnt.id.split('-')[1]);
            if(!resizer) return;
            resizer.addEventListener('mousedown', initResize, false);
            resizer.addEventListener('touchstart', initResizeTouch, false);
            function initResize(e) { window.addEventListener('mousemove', Resize, false); window.addEventListener('mouseup', stopResize, false); }
            function initResizeTouch(e) { window.addEventListener('touchmove', ResizeTouch, false); window.addEventListener('touchend', stopResize, false); }
            function Resize(e) { elmnt.style.width = (e.clientX - elmnt.offsetLeft) + 'px'; elmnt.style.height = (e.clientY - elmnt.offsetTop) + 'px'; }
            function ResizeTouch(e) { const t = e.touches[0]; elmnt.style.width = (t.clientX - elmnt.offsetLeft) + 'px'; elmnt.style.height = (t.clientY - elmnt.offsetTop) + 'px'; }
            function stopResize() { window.removeEventListener('mousemove', Resize, false); window.removeEventListener('mouseup', stopResize, false); window.removeEventListener('touchmove', ResizeTouch, false); window.removeEventListener('touchend', stopResize, false); }
        }

        ['modal-command', 'modal-media', 'modal-settings'].forEach(id => {
            const el = document.getElementById(id);
            makeDraggable(el); makeResizable(el);
        });

        // --- SYSTEM FUNCTIONS ---
        function initSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            audioPlayer = document.getElementById('audio-player');
            if (audioCtx.state === 'suspended') audioCtx.resume();
            requestWakeLock();
            micEnabled = true; populateVoices(); startContinuousListening(); initMusicDB();
            sfxOpen(); speak("Mobile Uplink Established.");
        }

        function getApiBase() { return customBridgeUrl ? customBridgeUrl.replace(/\/$/, "") : ""; }

        function openModal(id) { 
            sfxOpen(); 
            
            // Handle Core Vision Special Case
            if (id === 'core-vision') {
                toggleVisionMode();
                return;
            }
            
            document.querySelectorAll('.modal-window').forEach(w => w.style.display='none');
            const m = document.getElementById(id);
            if(!m.style.top || m.style.display === 'none') m.style.display = 'flex';
            else m.style.display = 'flex';
            
            document.querySelectorAll('.modal-window').forEach(w => w.style.zIndex = 20);
            m.style.zIndex = 30;
            if(id === 'modal-command') setTimeout(() => document.getElementById('chat-input').focus(), 50);
        }

        function closeModal(id) { 
            sfxClick(); document.getElementById(id).style.display='none'; 
        }
        
        // --- INTEGRATED VISION LOGIC ---
        function toggleVisionMode() {
            visionActive = !visionActive;
            const core = document.getElementById('core-vision-overlay');
            
            if (visionActive) {
                core.style.display = 'block';
                // Start Feed
                if(!usingLocalCamera) {
                    const base = getApiBase();
                    if(base) document.getElementById('vision-feed').src = base + "/video_feed?t=" + new Date().getTime();
                }
            } else {
                core.style.display = 'none';
                // Stop Feed logic if needed, but maybe keep running for quick toggle?
                // If local camera, stop it to save battery
                if (usingLocalCamera) toggleCameraSource();
                document.getElementById('vision-feed').src = "";
            }
            // Force redraw to hide/show core text
            resize(); 
        }

        // --- DRAWING ---
        window.addEventListener('resize', resize);
        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            centerX = width / 2; centerY = height / 2;
            scale = Math.min(width, height) * 0.19;
            
            // Update Core Vision Size to match Layer 7
            const coreSize = (scale * 0.30) * 2; 
            const cv = document.getElementById('core-vision-overlay');
            if(cv) {
                cv.style.width = coreSize + 'px';
                cv.style.height = coreSize + 'px';
            }
        }
        resize();

        function handleTouch(e) {
            const t = e.touches ? e.touches[0] : e;
            const rect = canvas.getBoundingClientRect();
            const mx = t.clientX - rect.left - centerX;
            const my = t.clientY - rect.top - centerY;
            const dist = Math.sqrt(mx*mx + my*my);
            const angle = Math.atan2(my, mx);
            
            if (dist > scale * 1.3 && dist < scale * 1.7) {
                for (let item of menuItems) {
                     let diff = angle - item.angle;
                     while(diff < -Math.PI) diff += Math.PI*2;
                     while(diff > Math.PI) diff -= Math.PI*2;
                     if (Math.abs(diff) < 0.4) { openModal(item.targetModal); return; }
                }
            }
        }
        window.addEventListener('touchstart', handleTouch);
        window.addEventListener('mousedown', handleTouch);

        function draw() {
            ctx.setTransform(1,0,0,1,0,0);
            ctx.clearRect(0,0,width,height);
            ctx.translate(centerX, centerY);
            
            // --- REACTOR Mk.III ---
            ctx.save(); ctx.rotate(time * 0.0005); 
            for (let i = 0; i < 60; i++) {
                ctx.rotate(Math.PI * 2 / 60); ctx.beginPath(); ctx.moveTo(scale*1.0,0); ctx.lineTo(scale*1.1,0);
                ctx.strokeStyle = colors.cyan; ctx.lineWidth = 1; ctx.stroke();
            }
            ctx.restore();

            ctx.save(); ctx.rotate(-time * 0.001);
            ctx.lineWidth = scale * 0.12; ctx.strokeStyle = 'rgba(0, 229, 255, 0.5)';
            for(let j=0; j<3; j++) {
                ctx.beginPath(); ctx.arc(0, 0, scale*0.85, 0, 1.2); ctx.stroke();
                ctx.rotate(Math.PI*2/3);
            }
            ctx.restore();

            ctx.save(); ctx.rotate(time * 0.002);
            ctx.strokeStyle = colors.cyan; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(0,0, scale*0.75, 0, Math.PI*2); ctx.stroke();
            ctx.restore();

            ctx.save(); ctx.rotate(-time * 0.003);
            ctx.lineWidth = scale * 0.1; ctx.strokeStyle = colors.cyan;
            for(let l=0; l<2; l++) {
                ctx.beginPath(); ctx.arc(0,0, scale*0.65, 0, 2.0); ctx.stroke();
                ctx.rotate(Math.PI);
            }
            ctx.restore();

            ctx.save(); ctx.rotate(time * 0.01);
            ctx.lineWidth = 6; ctx.strokeStyle = colors.orange; ctx.shadowColor = colors.orange; ctx.shadowBlur = 15;
            ctx.beginPath(); ctx.arc(0,0, scale*0.55, 0, 2.0); ctx.stroke();
            ctx.restore();

            ctx.save(); ctx.rotate(time * 0.02);
            ctx.lineWidth = 3; ctx.strokeStyle = colors.white; ctx.shadowColor = colors.white; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.arc(0,0, scale*0.45, 0, Math.PI*2); ctx.stroke();
            ctx.restore();

            // 7. Core (Only draw if Vision is NOT active)
            if (!visionActive) {
                ctx.save();
                ctx.fillStyle = colors.cyan; ctx.shadowColor = colors.cyan; ctx.shadowBlur = 40;
                ctx.globalAlpha = 0.6 + Math.sin(time * 0.05) * 0.2;
                ctx.beginPath(); ctx.arc(0,0, scale*0.30, 0, Math.PI*2); ctx.fill();
                
                ctx.globalAlpha = 1.0; ctx.fillStyle = "#FFFFFF";
                ctx.font = `bold ${scale * 0.15}px Orbitron`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.shadowBlur = 0; ctx.fillText("JARVIS", 0, 0);
                ctx.restore();
            }

            // ARC BUTTONS
            menuItems.forEach(item => {
                const r = scale * 1.4;
                const x = Math.cos(item.angle) * r;
                const y = Math.sin(item.angle) * r;
                const startAngle = item.angle - 0.3;
                const endAngle = item.angle + 0.3;
                
                ctx.beginPath(); 
                ctx.arc(0, 0, r, startAngle, endAngle);
                ctx.fillStyle = "rgba(0, 229, 255, 0.1)"; 
                ctx.strokeStyle = colors.cyan; 
                ctx.lineWidth = 25; // Thickness of the arc
                ctx.stroke();
                
                // Hover effect
                if(item.hovered) {
                     ctx.strokeStyle = colors.orange;
                     ctx.stroke();
                }

                ctx.fillStyle = "#FFF"; ctx.font = "10px Orbitron";
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(item.label, x, y);
            });

            time++;
            requestAnimationFrame(draw);
        }
        draw();

        // --- CORE LOGIC (AUDIO/API) ---
        function sfxOpen() { 
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.frequency.value = 600; gain.gain.value = 0.1;
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        }
        function sfxClick() { 
             const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
             osc.connect(gain); gain.connect(audioCtx.destination);
             osc.type = 'square'; osc.frequency.value = 1200; gain.gain.value = 0.05;
             osc.start(); osc.stop(audioCtx.currentTime + 0.05);
        }

        function loadMemory() {
            const k = localStorage.getItem('jarvis_api_key'); if(k) userApiKey = k;
            const u = localStorage.getItem('jarvis_bridge_url'); if(u) { customBridgeUrl = u; document.getElementById('bridge-url-input').value = u; checkBridgeHealth(); }
        }
        
        function saveApiKey(k) { userApiKey = k.trim(); localStorage.setItem('jarvis_api_key', userApiKey); }
        function saveBridgeUrl(u) { customBridgeUrl = u.trim(); localStorage.setItem('jarvis_bridge_url', customBridgeUrl); checkBridgeHealth(); }
        
        async function checkBridgeHealth() {
            const base = getApiBase();
            if(!base) return;
            try { await fetch(base + '/status'); document.getElementById('os-dot').style.background = '#00FF00'; } 
            catch(e) { document.getElementById('os-dot').style.background = '#FF0000'; }
        }
        
        // --- CAMERA ---
        async function toggleCameraSource() {
             const pc = document.getElementById('vision-feed');
             const loc = document.getElementById('local-vision-feed');
             
             if(!usingLocalCamera) {
                 try {
                     const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}});
                     localStream = stream;
                     loc.srcObject = stream;
                     loc.style.display = 'block'; pc.style.display = 'none';
                     usingLocalCamera = true;
                 } catch(e) { alert("Camera Error: " + e); }
             } else {
                 if(localStream) localStream.getTracks().forEach(t=>t.stop());
                 loc.style.display = 'none'; pc.style.display = 'block';
                 const base = getApiBase();
                 if(base) pc.src = base + "/video_feed?t=" + Date.now();
                 usingLocalCamera = false;
             }
        }
        
        // --- CHAT & COMMANDS ---
        async function handleChat(e) {
            if(e.key !== 'Enter') return;
            const msg = e.target.value;
            if(!msg) return;
            e.target.value = "";
            
            document.getElementById('chat-log').innerHTML += `<br><span style="color:#FFF">> ME:</span> ${msg}`;
            
            if(!userApiKey) { speak("API Key required in settings."); return; }
            
            const base = getApiBase();
            if(base && (msg.includes('scan') || msg.includes('security'))) {
                 try {
                     await fetch(base + '/command', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({command: msg})});
                     speak("Command sent to Base.");
                 } catch(e) { speak("Base unreachable."); }
                 return;
            }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${userApiKey}`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: msg }] }] })
                });
                const json = await res.json();
                const txt = json.candidates?.[0]?.content?.parts?.[0]?.text;
                if(txt) {
                    document.getElementById('chat-log').innerHTML += `<br><span style="color:#00E5FF">> JARVIS:</span> ${txt}`;
                    speak(txt);
                }
            } catch(e) { console.log(e); }
        }
        
        // --- SPEECH ---
        function startContinuousListening() {
             if(!('webkitSpeechRecognition' in window)) return;
             recognition = new webkitSpeechRecognition();
             recognition.continuous = true;
             recognition.lang = 'en-US';
             recognition.onresult = (e) => {
                 const txt = e.results[e.results.length-1][0].transcript;
                 handleChat({key:'Enter', target:{value:txt}});
             };
             recognition.onend = () => { if(micEnabled) recognition.start(); };
             recognition.start();
        }
        
        function speak(text) {
            const u = new SpeechSynthesisUtterance(text);
            speechSynthesis.speak(u);
        }

        // DB & Media placeholders (simplified for mobile stability)
        function initMusicDB() {} 
        function testVoice() { speak("Systems nominal."); }

        window.addEventListener('load', loadMemory);

    </script>
</body>
</html>