<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Security & PWA Settings -->
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    
    <!-- Android/iOS Native Feel -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="format-detection" content="telephone=no">
    
    <title>JARVIS: MOBILE UNIT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- CORE SYSTEM STYLES --- */
        :root {
            --primary: #00E5FF;
            --secondary: rgba(0, 229, 255, 0.15);
            --bg-color: #000000; /* OLED Black */
            --alert: #FFA500;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { 
            -webkit-tap-highlight-color: transparent; 
            user-select: none; 
            box-sizing: border-box; 
            outline: none;
        }

        html, body { 
            margin: 0; padding: 0;
            overflow: hidden; 
            background-color: var(--bg-color); 
            font-family: 'Orbitron', sans-serif; 
            color: var(--primary); 
            height: 100vh; width: 100vw; 
            display: flex; justify-content: center; align-items: center; 
            touch-action: none; 
            overscroll-behavior: none; 
        }
        
        /* REACTOR BACKGROUND */
        #reactor-container { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 100vw; height: 100vh; z-index: 0; 
            opacity: 0.8; 
            pointer-events: none; 
        }
        canvas { display: block; }
        
        /* CORE VISION OVERLAY */
        #core-vision-overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 50%; overflow: hidden; z-index: 5; 
            display: none; background: #000; border: 2px solid var(--primary);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5); pointer-events: auto;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        #core-vision-overlay.core-expanded {
            width: 95vw !important; height: 80vh !important; border-radius: 20px;
            border: 2px solid var(--alert); box-shadow: 0 0 50px rgba(255, 165, 0, 0.4);
            z-index: 200; background: rgba(0,0,0,0.9);
        }

        #core-vision-overlay img, #core-vision-overlay video { width: 100%; height: 100%; object-fit: cover; }
        
        /* VISION CONTROLS */
        .vision-controls {
            position: absolute; bottom: 20px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px;
            pointer-events: none; opacity: 0; transition: opacity 0.3s;
        }
        #core-vision-overlay.core-expanded .vision-controls { opacity: 1; }
        
        .vision-btn {
            pointer-events: auto; background: rgba(0,0,0,0.8); border: 1px solid var(--primary);
            color: var(--primary); border-radius: 50%; width: 50px; height: 50px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; font-size: 20px; box-shadow: 0 0 15px rgba(0,229,255,0.2);
        }

        /* STATUS OVERLAYS */
        #overlay-text { 
            position: absolute; bottom: calc(20px + var(--safe-bottom)); 
            width: 100%; text-align: center; color: var(--primary); 
            font-size: 10px; opacity: 0.6; z-index: 2; pointer-events: none; 
            font-family: 'Share Tech Mono', monospace;
        }
        #mic-status { 
            position: absolute; top: calc(20px + var(--safe-top)); 
            width: 100%; text-align: center; color: rgba(0, 229, 255, 0.8); 
            font-size: 12px; letter-spacing: 3px; z-index: 2; font-weight: 700; 
            pointer-events: none; text-shadow: 0 0 5px var(--primary);
        }
        
        /* INIT OVERLAY */
        #start-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #000000; z-index: 9999; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
        }
        #start-btn { 
            padding: 20px 40px; border: 1px solid var(--primary); 
            background: rgba(0, 229, 255, 0.05); color: var(--primary); 
            font-family: 'Orbitron'; font-size: 18px; font-weight: 900; 
            letter-spacing: 2px; cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 229, 255, 0.1);
            animation: pulse 2s infinite;
        }
        @keyframes pulse { 0% { opacity: 0.8; } 50% { opacity: 1; border-color: #fff; } 100% { opacity: 0.8; } }

        /* MODALS */
        .modal-window { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(5, 8, 12, 0.98); 
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            z-index: 100; pointer-events: auto;
            display: flex; flex-direction: column;
            transform: translateY(110%);
            transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
            padding-top: var(--safe-top);
            padding-bottom: var(--safe-bottom);
        }
        .modal-window.active { transform: translateY(0); }

        .modal-header { 
            padding: 20px; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid rgba(0, 229, 255, 0.3); background: rgba(0, 20, 30, 0.5);
        }
        .modal-title { font-size: 16px; font-weight: 900; letter-spacing: 1px; color: #fff; }
        .close-btn { 
            font-size: 24px; width: 40px; height: 40px; 
            display: flex; align-items: center; justify-content: center;
            color: var(--primary); cursor: pointer; 
        }
        .modal-body { flex: 1; padding: 20px; overflow-y: auto; color: #ccc; display: flex; flex-direction: column; gap: 15px; }

        /* INPUTS & BUTTONS */
        .input-group { display: flex; gap: 10px; margin-top: auto; }
        input[type="text"], input[type="password"] { 
            background: rgba(10, 20, 30, 0.8); border: 1px solid #333; 
            color: var(--primary); padding: 15px; flex: 1; outline: none; 
            font-family: 'Share Tech Mono'; font-size: 16px; border-radius: 5px;
        }
        button { 
            background: rgba(0, 229, 255, 0.1); color: var(--primary); 
            border: 1px solid var(--primary); padding: 15px; 
            font-family: 'Orbitron'; font-weight: bold; cursor: pointer; 
            transition: 0.2s; border-radius: 4px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        button:active { background: var(--primary); color: #000; }
        
        /* CHAT */
        .chat-log { 
            flex: 1; overflow-y: auto; margin-bottom: 15px; 
            font-size: 14px; line-height: 1.5; font-family: 'Share Tech Mono', monospace; 
            color: #aaa; padding: 10px; border: 1px solid rgba(255,255,255,0.05);
        }
        .msg-user { color: #fff; margin-bottom: 5px; display: block; }
        .msg-sys { color: var(--primary); margin-bottom: 10px; display: block; border-left: 2px solid var(--primary); padding-left: 10px;}

        /* SETTINGS ROWS */
        .setting-row { 
            display: flex; align-items: center; justify-content: space-between; 
            padding: 15px; background: rgba(255,255,255,0.03); border-radius: 5px;
        }
        .setting-label { color: #ccc; font-size: 14px; font-weight: bold; }

        /* --- MOTO HUD SPECIFIC STYLES --- */
        #moto-hud {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 900;
            display: none; flex-direction: column;
            color: var(--primary);
            font-family: 'Share Tech Mono', monospace;
            padding: var(--safe-top) 0 var(--safe-bottom) 0;
        }
        
        .hud-top-bar {
            height: 60px; border-bottom: 2px solid var(--primary);
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
            background: rgba(0, 229, 255, 0.05);
        }
        
        .compass-tape {
            font-size: 20px; font-weight: bold;
            display: flex; gap: 40px;
            transition: transform 0.1s linear;
        }

        .hud-main-display {
            flex: 1; display: flex; align-items: center; justify-content: center;
            position: relative;
        }

        .speed-container {
            text-align: center;
            z-index: 2;
        }
        
        .speed-val {
            font-size: 120px; font-weight: 900;
            font-family: 'Orbitron';
            color: #fff;
            text-shadow: 0 0 20px var(--primary);
            line-height: 1;
        }
        
        .speed-unit {
            font-size: 24px; letter-spacing: 5px;
            color: var(--primary); opacity: 0.8;
        }

        /* Lean Angle Indicators */
        .lean-indicator {
            position: absolute; top: 50%; width: 20px; height: 200px;
            background: rgba(255,255,255,0.1); border: 1px solid #333;
            transform: translateY(-50%);
            display: flex; flex-direction: column-reverse;
        }
        .lean-left { left: 20px; }
        .lean-right { right: 20px; }
        .lean-bar-fill { width: 100%; background: var(--alert); transition: height 0.1s; }

        .hud-bottom-bar {
            height: 80px; display: flex; justify-content: space-between; align-items: center;
            padding: 0 20px; border-top: 1px solid #333;
            background: rgba(0,0,0,0.8);
        }
        
        .hud-btn-nav {
            padding: 10px 20px; border: 1px solid var(--alert); color: var(--alert);
            font-size: 14px; background: rgba(255, 165, 0, 0.1);
        }
        
        .hud-time { font-size: 32px; font-weight: bold; color: #fff; }

    </style>
</head>
<body>

    <!-- STARTUP -->
    <div id="start-overlay" onclick="initSystem()">
        <div style="font-size: 40px; color: var(--primary); margin-bottom: 20px;"><i class="fas fa-fingerprint"></i></div>
        <div id="start-btn">INITIALIZE SYSTEM</div>
        <div style="margin-top: 20px; opacity: 0.5; font-size: 10px; font-family: 'Share Tech Mono';">SECURE MOBILE TERMINAL</div>
    </div>

    <!-- REACTOR -->
    <div id="reactor-container"><canvas id="reactor"></canvas></div>
    
    <!-- HUD ELEMENTS -->
    <div id="mic-status">OFFLINE</div>
    <div id="overlay-text">WAITING FOR BIOMETRIC ENTRY</div>

    <!-- MOTO HUD (New Feature) -->
    <div id="moto-hud">
        <div class="hud-top-bar">
            <div class="compass-marker" style="position:absolute; bottom:0; width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 10px solid var(--alert); z-index:10;"></div>
            <div class="compass-tape" id="hud-compass">
                <span>N</span><span>NE</span><span>E</span><span>SE</span><span>S</span><span>SW</span><span>W</span><span>NW</span><span>N</span>
            </div>
        </div>
        
        <div class="hud-main-display">
            <!-- Left Lean -->
            <div class="lean-indicator lean-left"><div class="lean-bar-fill" id="fill-left" style="height: 0%;"></div></div>
            
            <div class="speed-container">
                <div class="speed-val" id="hud-speed">0</div>
                <div class="speed-unit">KM/H</div>
            </div>
            
            <!-- Right Lean -->
            <div class="lean-indicator lean-right"><div class="lean-bar-fill" id="fill-right" style="height: 0%;"></div></div>
        </div>
        
        <div class="hud-bottom-bar">
            <button class="hud-btn-nav" onclick="closeHUD()"><i class="fas fa-times"></i> EXIT</button>
            <div class="hud-time" id="hud-clock">00:00</div>
            <button class="hud-btn-nav" onclick="launchMaps()"><i class="fas fa-location-arrow"></i> NAV</button>
        </div>
    </div>

    <!-- VISION MODULE -->
    <div id="core-vision-overlay">
        <img id="vision-feed" src="" style="display: block;" onerror="this.style.display='none';">
        <video id="local-vision-feed" autoplay playsinline style="display: none; transform: scaleX(-1);"></video>
        
        <div class="vision-controls">
            <div class="vision-btn" onclick="event.stopPropagation(); toggleCameraSource()"><i class="fas fa-sync-alt"></i></div>
            <div class="vision-btn" onclick="event.stopPropagation(); closeVision()"><i class="fas fa-times"></i></div>
        </div>
    </div>

    <!-- MODAL: COMMAND -->
    <div id="modal-command" class="modal-window">
        <div class="modal-header">
            <span class="modal-title"><i class="fas fa-terminal"></i> MAIN CONSOLE</span>
            <span class="close-btn" onclick="closeModal('modal-command')">×</span>
        </div>
        <div class="modal-body">
            <div class="chat-log" id="chat-log">
                <span class="msg-sys">SYSTEM INITIALIZED.<br>IDENTITY VERIFIED: DIMITRI (JIM).</span>
            </div>
            <div class="input-group">
                <input type="text" id="chat-input" placeholder="Enter command..." onkeydown="handleChat(event)" autocomplete="off">
                <button onclick="toggleVoiceInput()"><i id="mic-icon" class="fas fa-microphone"></i></button>
            </div>
        </div>
    </div>

    <!-- MODAL: SETTINGS -->
    <div id="modal-settings" class="modal-window">
        <div class="modal-header">
            <span class="modal-title"><i class="fas fa-cog"></i> CONFIGURATION</span>
            <span class="close-btn" onclick="closeModal('modal-settings')">×</span>
        </div>
        <div class="modal-body">
            <div class="setting-row">
                <div class="setting-label">GEMINI API KEY</div>
                <input type="password" id="api-key-input" onchange="saveApiKey(this.value)" style="width: 50%; text-align:right;">
            </div>
            
            <div style="border-top: 1px solid #333; margin-top: 10px; padding-top: 20px;">
                <button onclick="activateHUD()" style="width:100%; color: var(--alert); border-color: var(--alert);">
                    <i class="fas fa-motorcycle"></i> ACTIVATE MOTO HUD
                </button>
            </div>

            <button onclick="requestFullScreen()" style="margin-top:20px;">TOGGLE FULLSCREEN</button>
        </div>
    </div>

    <!-- MODAL: MEDIA -->
    <div id="modal-media" class="modal-window">
        <div class="modal-header">
            <span class="modal-title"><i class="fas fa-music"></i> MEDIA LINK</span>
            <span class="close-btn" onclick="closeModal('modal-media')">×</span>
        </div>
        <div class="modal-body">
            <div style="text-align:center; padding: 20px; border: 1px solid #333; border-radius: 10px;">
                <i class="fas fa-headphones-alt" style="font-size: 40px; color: #555;"></i>
                <div id="now-playing" style="margin-top:10px; color:var(--primary);">NO SIGNAL</div>
            </div>
            <input type="file" id="media-upload" accept="audio/*" multiple onchange="handleMediaSelect(this)" style="display:none;">
            <button onclick="document.getElementById('media-upload').click()">LOAD LOCAL FILES</button>
            <audio id="audio-player" controls style="width: 100%; margin-top: 10px;"></audio>
        </div>
    </div>

    <script>
        /* --- SYSTEM CORE --- */
        const canvas = document.getElementById('reactor');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, centerY, scale, time = 0;
        let animationFrame;
        
        // System State
        let systemConfig = {
            apiKey: localStorage.getItem('jarvis_api_key') || '',
            userName: 'Jim'
        };
        
        let visionActive = false;
        let usingLocalCamera = false;
        let localStream = null;
        let audioCtx, recognition;
        
        // HUD State
        let hudActive = false;
        let watchId = null;

        // UI Config
        const colors = { cyan: '#00E5FF', orange: '#FFA500', white: '#FFFFFF' };
        
        const menuItems = [
            { id: 'media', label: 'MEDIA', icon: 'fa-music', target: 'modal-media', angle: -Math.PI * 0.75 }, 
            { id: 'config', label: 'CONFIG', icon: 'fa-cog', target: 'modal-settings', angle: -Math.PI * 0.25 }, 
            { id: 'vision', label: 'VISION', icon: 'fa-eye', target: 'vision-toggle', angle: Math.PI * 0.25 },
            { id: 'cmd', label: 'CMD', icon: 'fa-terminal', target: 'modal-command', angle: Math.PI * 0.75 }
        ];

        /* --- INITIALIZATION --- */
        async function initSystem() {
            if ('wakeLock' in navigator) { 
                try { await navigator.wakeLock.request('screen'); } catch (err) { console.log('Wake Lock failed'); }
            }
            
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            
            document.getElementById('start-overlay').style.opacity = '0';
            setTimeout(() => document.getElementById('start-overlay').style.display = 'none', 500);
            document.getElementById('mic-status').innerText = "ONLINE";
            document.getElementById('overlay-text').innerText = "SYSTEM ACTIVE";
            
            if(systemConfig.apiKey) document.getElementById('api-key-input').value = systemConfig.apiKey;

            resize();
            draw();
            initSpeech();
            sfx('startup');
            speak("Welcome back, Sir. Systems are online.");
        }

        function requestFullScreen() {
            const doc = document.documentElement;
            if (doc.requestFullscreen) doc.requestFullscreen();
            else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen();
        }

        /* --- MOTO HUD LOGIC --- */
        function activateHUD() {
            closeModal('modal-settings');
            document.getElementById('moto-hud').style.display = 'flex';
            hudActive = true;
            requestFullScreen();
            speak("Heads Up Display Activated. Ride safe, Sir.");
            
            // Start GPS Watch
            if ('geolocation' in navigator) {
                watchId = navigator.geolocation.watchPosition(updateSpeed, (err) => console.log(err), {
                    enableHighAccuracy: true,
                    maximumAge: 1000,
                    timeout: 27000
                });
            }
            
            // Start Orientation
            window.addEventListener('deviceorientation', handleOrientation);
            
            // Start Clock
            updateClock();
            setInterval(updateClock, 1000);
        }

        function closeHUD() {
            document.getElementById('moto-hud').style.display = 'none';
            hudActive = false;
            if (watchId) navigator.geolocation.clearWatch(watchId);
            window.removeEventListener('deviceorientation', handleOrientation);
        }

        function updateSpeed(position) {
            if (!hudActive) return;
            // speed is in m/s. Convert to km/h: speed * 3.6
            let speed = position.coords.speed;
            if (speed === null || speed < 0) speed = 0;
            const kmh = Math.round(speed * 3.6);
            document.getElementById('hud-speed').innerText = kmh;
        }

        function handleOrientation(event) {
            if (!hudActive) return;
            
            // Compass (Alpha)
            const alpha = event.alpha || 0; 
            // We shift the tape based on alpha. 360 degrees = full width roughly
            // Simple visual approximation
            const offset = (alpha / 360) * 100; 
            // We want center to be current heading. 
            // A more complex implementation creates an infinite tape, simplified here:
            document.getElementById('hud-compass').style.transform = `translateX(${-offset}%)`;

            // Lean (Gamma) - Roll left/right
            const gamma = event.gamma || 0; // -90 to 90
            let leanLeft = 0;
            let leanRight = 0;
            
            if (gamma < -5) leanLeft = Math.min(Math.abs(gamma), 45); // Cap visualization at 45 deg
            if (gamma > 5) leanRight = Math.min(gamma, 45);

            // Scale to height percentage (45 deg = 100%)
            document.getElementById('fill-left').style.height = (leanLeft * 2.2) + '%';
            document.getElementById('fill-right').style.height = (leanRight * 2.2) + '%';
        }

        function updateClock() {
            if (!hudActive) return;
            const now = new Date();
            document.getElementById('hud-clock').innerText = 
                now.getHours().toString().padStart(2, '0') + ':' + 
                now.getMinutes().toString().padStart(2, '0');
        }

        function launchMaps() {
            window.open("https://www.google.com/maps", "_blank");
        }

        /* --- REACTOR GRAPHICS --- */
        window.addEventListener('resize', resize);
        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            centerX = width / 2; centerY = height / 2;
            scale = Math.min(width, height) * (width < 768 ? 0.40 : 0.25);
        }

        function draw() {
            if (hudActive) {
                // Skip rendering reactor if HUD is on to save battery
                animationFrame = requestAnimationFrame(draw);
                return;
            }

            ctx.setTransform(1,0,0,1,0,0);
            ctx.clearRect(0,0,width,height);
            ctx.translate(centerX, centerY);
            
            // Reactor Rings (Standard Jarvis Loop)
            ctx.save(); ctx.rotate(time * 0.0005); 
            for (let i = 0; i < 60; i++) {
                ctx.rotate(Math.PI * 2 / 60); ctx.beginPath(); ctx.moveTo(scale*1.0,0); ctx.lineTo(scale*1.1,0);
                ctx.strokeStyle = colors.cyan; ctx.lineWidth = 1; ctx.stroke();
            }
            ctx.restore();

            ctx.save(); ctx.rotate(-time * 0.001);
            ctx.lineWidth = scale * 0.12; ctx.strokeStyle = 'rgba(0, 229, 255, 0.5)';
            for(let j=0; j<3; j++) {
                ctx.beginPath(); ctx.arc(0, 0, scale*0.85, 0, 1.2); ctx.stroke();
                ctx.rotate(Math.PI*2/3);
            }
            ctx.restore();

            ctx.save(); ctx.rotate(time * 0.002);
            ctx.strokeStyle = colors.cyan; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(0,0, scale*0.75, 0, Math.PI*2); ctx.stroke();
            ctx.restore();

            ctx.save(); ctx.rotate(-time * 0.003);
            ctx.lineWidth = scale * 0.1; ctx.strokeStyle = colors.cyan;
            for(let l=0; l<2; l++) {
                ctx.beginPath(); ctx.arc(0,0, scale*0.65, 0, 2.0); ctx.stroke();
                ctx.rotate(Math.PI);
            }
            ctx.restore();

            ctx.save(); ctx.rotate(time * 0.01);
            ctx.lineWidth = 6; ctx.strokeStyle = colors.orange; ctx.shadowColor = colors.orange; ctx.shadowBlur = 15;
            ctx.beginPath(); ctx.arc(0,0, scale*0.55, 0, 2.0); ctx.stroke();
            ctx.restore();

            ctx.save(); ctx.rotate(time * 0.02);
            ctx.lineWidth = 3; ctx.strokeStyle = colors.white; ctx.shadowColor = colors.white; ctx.shadowBlur = 10;
            ctx.beginPath(); ctx.arc(0,0, scale*0.45, 0, Math.PI*2); ctx.stroke();
            ctx.restore();

            if (!visionActive) {
                ctx.save();
                ctx.fillStyle = colors.cyan; ctx.shadowColor = colors.cyan; ctx.shadowBlur = 40;
                ctx.globalAlpha = 0.6 + Math.sin(time * 0.05) * 0.2;
                ctx.beginPath(); ctx.arc(0,0, scale*0.30, 0, Math.PI*2); ctx.fill();
                
                ctx.globalAlpha = 1.0; ctx.fillStyle = "#FFFFFF";
                ctx.font = `bold ${scale * 0.15}px Orbitron`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.shadowBlur = 0; ctx.fillText("JARVIS", 0, 0);
                ctx.restore();
            }

            drawMenu();
            time++;
            animationFrame = requestAnimationFrame(draw);
        }

        function drawMenu() {
            menuItems.forEach(item => {
                const outerR = scale * 1.6;
                const innerR = scale * 1.35;
                const angleWidth = 0.25;
                const startAngle = item.angle - angleWidth;
                const endAngle = item.angle + angleWidth;

                ctx.save();
                ctx.beginPath();
                ctx.arc(0, 0, outerR, startAngle, endAngle);
                ctx.arc(0, 0, innerR, endAngle, startAngle, true);
                ctx.closePath();

                ctx.fillStyle = "rgba(0, 10, 20, 0.8)"; 
                ctx.fill();
                ctx.strokeStyle = colors.cyan; ctx.lineWidth = 1; ctx.stroke();

                const midR = (outerR + innerR) / 2;
                const txtX = Math.cos(item.angle) * midR;
                const txtY = Math.sin(item.angle) * midR;

                ctx.fillStyle = "#00E5FF"; 
                ctx.font = `bold ${scale * 0.08}px Orbitron`;
                ctx.textAlign = "center"; ctx.textBaseline = "middle";
                ctx.fillText(item.label, txtX, txtY);
                ctx.restore();
            });
        }

        /* --- INPUT HANDLING --- */
        let touchActive = false;
        
        window.addEventListener('touchstart', handleInput, {passive: false});
        window.addEventListener('mousedown', (e) => { if(!touchActive) handleInput(e); });

        function handleInput(e) {
            // Disable menu interaction if HUD is active
            if(hudActive) return; 

            touchActive = e.type === 'touchstart';
            const clientX = touchActive ? e.touches[0].clientX : e.clientX;
            const clientY = touchActive ? e.touches[0].clientY : e.clientY;

            const rect = canvas.getBoundingClientRect();
            const dx = clientX - (rect.left + centerX);
            const dy = clientY - (rect.top + centerY);
            const dist = Math.sqrt(dx*dx + dy*dy);
            const angle = Math.atan2(dy, dx);

            if (dist > scale * 1.3 && dist < scale * 1.7) {
                menuItems.forEach(item => {
                    let diff = angle - item.angle;
                    while(diff < -Math.PI) diff += Math.PI*2;
                    while(diff > Math.PI) diff -= Math.PI*2;
                    
                    if (Math.abs(diff) < 0.3) {
                        e.preventDefault();
                        hapticFeedback();
                        if (item.target === 'vision-toggle') toggleVision();
                        else openModal(item.target);
                    }
                });
            } else if (dist < scale * 0.4) {
                 toggleVoiceInput();
            }
        }

        function hapticFeedback() { if (navigator.vibrate) navigator.vibrate(15); }

        function openModal(id) {
            sfx('click');
            document.querySelectorAll('.modal-window').forEach(m => m.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function closeModal(id) {
            sfx('close');
            document.getElementById(id).classList.remove('active');
        }

        /* --- VISION SYSTEM --- */
        function toggleVision() {
            sfx('click');
            visionActive = !visionActive;
            const overlay = document.getElementById('core-vision-overlay');
            
            if (visionActive) {
                overlay.style.display = 'block';
                setTimeout(() => overlay.classList.add('core-expanded'), 10);
                if (!usingLocalCamera) startRemoteStream(); 
                else startLocalCamera();
            } else {
                overlay.classList.remove('core-expanded');
                setTimeout(() => overlay.style.display = 'none', 300);
                stopAllVideo();
            }
        }

        function closeVision() { visionActive = false; toggleVision(); }

        async function startLocalCamera() {
            const video = document.getElementById('local-vision-feed');
            const img = document.getElementById('vision-feed');
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = localStream;
                video.style.display = 'block';
                img.style.display = 'none';
                usingLocalCamera = true;
            } catch (err) { alert("Camera access denied."); }
        }

        function startRemoteStream() { startLocalCamera(); }
        function toggleCameraSource() { hapticFeedback(); startLocalCamera(); }

        function stopAllVideo() {
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
            document.getElementById('vision-feed').src = "";
        }

        /* --- AUDIO & AI --- */
        function sfx(type) {
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            if (type === 'startup') {
                osc.frequency.setValueAtTime(200, audioCtx.currentTime);
                osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.5);
                gain.gain.setValueAtTime(0.2, audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5);
                osc.start(); osc.stop(audioCtx.currentTime + 0.5);
            } else {
                osc.frequency.value = 1200; gain.gain.value = 0.05; osc.type = 'square';
                osc.start(); osc.stop(audioCtx.currentTime + 0.05);
            }
        }

        function speak(text) {
            if (window.speechSynthesis) {
                const u = new SpeechSynthesisUtterance(text);
                const voices = speechSynthesis.getVoices();
                const brit = voices.find(v => v.name.includes('Great Britain') || v.name.includes('UK') && v.name.includes('Male'));
                if (brit) u.voice = brit;
                u.rate = 1.0; u.pitch = 1.0;
                speechSynthesis.speak(u);
            }
        }

        function initSpeech() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) { document.getElementById('mic-status').innerText = "NO MIC SUPPORT"; return; }
            recognition = new SpeechRecognition();
            recognition.continuous = false; recognition.lang = 'en-GB';
            recognition.onstart = () => {
                document.getElementById('mic-status').innerText = "LISTENING...";
                document.getElementById('mic-status').style.color = colors.orange;
                document.getElementById('mic-icon').style.color = colors.orange;
            };
            recognition.onend = () => {
                document.getElementById('mic-status').innerText = "ONLINE";
                document.getElementById('mic-status').style.color = colors.cyan;
                document.getElementById('mic-icon').style.color = "";
            };
            recognition.onresult = (e) => { processCommand(e.results[0][0].transcript); };
        }

        function toggleVoiceInput() { hapticFeedback(); try { recognition.start(); } catch(e) { recognition.stop(); } }
        function handleChat(e) { if (e.key === 'Enter') { processCommand(e.target.value); e.target.value = ''; e.target.blur(); } }

        async function processCommand(cmd) {
            if (!cmd) return;
            const log = document.getElementById('chat-log');
            log.innerHTML += `<span class="msg-user">> ${cmd.toUpperCase()}</span>`;
            log.scrollTop = log.scrollHeight;

            if (cmd.toLowerCase().includes('vision') || cmd.toLowerCase().includes('camera')) { toggleVision(); return; }
            
            if (!systemConfig.apiKey) {
                speak("I need an API key, Sir.");
                log.innerHTML += `<span class="msg-sys">ERROR: MISSING API KEY</span>`;
                return;
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${systemConfig.apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `You are JARVIS. Answer briefly to Dimitri (Jim). Request: ${cmd}` }] }]
                    })
                });
                const data = await response.json();
                const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Processing error.";
                log.innerHTML += `<span class="msg-sys">${reply.toUpperCase()}</span>`;
                log.scrollTop = log.scrollHeight;
                speak(reply);
            } catch (err) {
                console.error(err);
                log.innerHTML += `<span class="msg-sys">CONNECTION ERROR</span>`;
                speak("I cannot reach the cloud, Sir.");
            }
        }

        function saveApiKey(val) { systemConfig.apiKey = val.trim(); localStorage.setItem('jarvis_api_key', val); }

        function handleMediaSelect(input) {
            const files = input.files;
            if (files.length > 0) {
                const url = URL.createObjectURL(files[0]);
                const player = document.getElementById('audio-player');
                player.src = url;
                document.getElementById('now-playing').innerText = files[0].name;
                player.play();
            }
        }
        
        window.addEventListener('beforeunload', () => { if (localStream) localStream.getTracks().forEach(t => t.stop()); });

    </script>
</body>
</html>


