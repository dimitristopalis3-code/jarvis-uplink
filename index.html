<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    <title>JARVIS: MOBILE UNIT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;500;700;900&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- TENSORFLOW & MODELS -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/mobilenet"></script>

    <style>
        :root {
            --primary: #00E5FF;
            --secondary: rgba(0, 229, 255, 0.2);
            --bg-color: #000000;
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
        }

        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; outline: none; }
        html, body { margin: 0; padding: 0; overflow: hidden; background-color: var(--bg-color); font-family: 'Orbitron', sans-serif; color: var(--primary); height: 100vh; width: 100vw; display: flex; justify-content: center; align-items: center; touch-action: none; overscroll-behavior: none; }
        
        /* BACKGROUND */
        #reactor-container { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: 1; }
        canvas { display: block; width: 100%; height: 100%; }
        
        /* --- VISION SYSTEM --- */
        #vision-container {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: #000; z-index: 200; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }

        #vision-feed-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; background: #000; }
        #local-vision-feed { width: 100%; height: 100%; object-fit: cover; }
        #local-vision-feed.mirrored { transform: scaleX(-1); }
        #vision-ar-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 20; pointer-events: none; }

        .vision-controls-bar {
            position: absolute; bottom: 40px; width: 100%;
            display: flex; justify-content: center; gap: 20px; pointer-events: auto; z-index: 50;
        }
        .v-btn {
            background: rgba(0,0,0,0.6); border: 1px solid var(--primary);
            color: var(--primary); border-radius: 50%; width: 60px; height: 60px;
            display: flex; align-items: center; justify-content: center;
            font-size: 20px; box-shadow: 0 0 15px rgba(0,229,255,0.2); cursor: pointer;
            backdrop-filter: blur(5px);
        }
        .v-btn:active { transform: scale(0.95); background: rgba(0, 229, 255, 0.2); }
        .v-btn.recording { border-color: red; color: red; animation: pulse-red 1s infinite; }
        @keyframes pulse-red { 0% { box-shadow: 0 0 0 rgba(255,0,0,0.5); } 70% { box-shadow: 0 0 20px rgba(255,0,0,0); } 100% { box-shadow: 0 0 0 rgba(255,0,0,0); } }

        /* GENERAL UI */
        #start-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #start-btn { padding: 20px 40px; border: 1px solid var(--primary); color: var(--primary); font-family: 'Orbitron'; font-size: 18px; font-weight: 900; animation: pulse 2s infinite; cursor: pointer; }
        @keyframes pulse { 0% { box-shadow: 0 0 10px rgba(0,229,255,0.2); } 50% { box-shadow: 0 0 25px var(--primary); border-color: #fff; } 100% { box-shadow: 0 0 10px rgba(0,229,255,0.2); } }

        /* MODALS */
        .modal-window { 
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(5, 8, 12, 0.98); backdrop-filter: blur(10px); z-index: 300; 
            display: flex; flex-direction: column; transform: translateY(110%);
            transition: transform 0.4s ease; padding-top: var(--safe-top);
        }
        .modal-window.active { transform: translateY(0); }
        .modal-header { padding: 20px; border-bottom: 1px solid rgba(0,229,255,0.2); display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;}
        .modal-body { padding: 20px; overflow-y: auto; flex: 1; display: flex; flex-direction: column; gap: 15px; }

        /* DB & MEDIA */
        .db-entry { border: 1px solid rgba(0,229,255,0.2); padding: 10px; border-radius: 5px; display: flex; gap: 10px; align-items: center; justify-content: space-between; background: rgba(0,20,40,0.5); }
        .db-info { flex: 1; display: flex; flex-direction: column; gap: 2px; }
        .db-img { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; border: 1px solid var(--primary); }
        .db-actions { display: flex; gap: 10px; }
        .delete-btn { color: #FF0000; border: 1px solid #FF0000; padding: 5px 10px; border-radius: 3px; font-size: 12px; cursor: pointer; }
        
        input, select { background: #111; border: 1px solid #333; color: var(--primary); padding: 15px; width: 100%; font-family: 'Share Tech Mono'; margin-bottom: 10px; }
        .text-btn { padding: 15px; background: rgba(0, 229, 255, 0.1); border: 1px solid var(--primary); color: var(--primary); font-family: 'Orbitron'; font-weight: bold; width: 100%; }
        .text-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* PLAYLIST STYLES */
        #playlist-container { flex: 1; overflow-y: auto; margin-top: 10px; border-top: 1px solid rgba(0,229,255,0.3); scrollbar-width: thin; scrollbar-color: var(--primary) transparent; }
        #playlist-container::-webkit-scrollbar { width: 5px; }
        #playlist-container::-webkit-scrollbar-thumb { background: var(--primary); border-radius: 2px; }
        .track-item { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; font-family: 'Share Tech Mono'; font-size: 14px; color: #888; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
        .track-item:hover { background: rgba(0, 229, 255, 0.05); color: #ccc; }
        .track-item.active-track { color: var(--primary); background: rgba(0, 229, 255, 0.1); border-left: 3px solid var(--primary); }
        .track-icon { width: 20px; text-align: center; }

        /* COMMS GRID */
        .comms-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .comms-btn {
            background: rgba(0, 20, 40, 0.8); border: 1px solid var(--primary); border-radius: 10px;
            padding: 20px; display: flex; flex-direction: column; align-items: center; gap: 10px;
            cursor: pointer; transition: all 0.2s;
        }
        .comms-btn:active { background: var(--primary); color: #000; }
        .comms-icon { font-size: 32px; color: var(--primary); }
        .comms-btn:active .comms-icon { color: #000; }
        .comms-label { font-size: 12px; font-family: 'Orbitron'; letter-spacing: 1px; }

    </style>
</head>
<body>

    <!-- STARTUP -->
    <div id="start-overlay" onclick="initSystem(event)">
        <div style="font-size: 50px; color: var(--primary); margin-bottom: 20px;"><i class="fas fa-fingerprint"></i></div>
        <div id="start-btn">INITIALIZE JARVIS</div>
        <div style="margin-top: 20px; font-size: 12px; font-family: 'Share Tech Mono'; opacity: 0.6;">T-FORCE SECURITY PROTOCOLS</div>
        <div id="model-status" style="margin-top:20px; font-size: 12px; color: #FFA500;">SYSTEM STANDBY</div>
    </div>

    <!-- MAIN REACTOR (UNIFIED HUD) -->
    <div id="reactor-container"><canvas id="reactor"></canvas></div>

    <!-- VISION SYSTEM -->
    <div id="vision-container">
        <div id="vision-feed-layer"><video id="local-vision-feed" autoplay playsinline muted></video></div>
        <canvas id="vision-ar-canvas"></canvas>
        <div id="cam-error-msg" style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:100%; text-align:center; display:none; z-index: 100;"><i class="fas fa-exclamation-triangle" style="font-size:40px; color:var(--primary); margin-bottom:10px;"></i><br>VIDEO SIGNAL LOST</div>
        <div class="vision-controls-bar">
            <div class="v-btn" onclick="toggleCameraSource()" title="Switch Cam"><i class="fas fa-sync-alt"></i></div>
            <div class="v-btn" onclick="takePhoto()" title="Take Photo"><i class="fas fa-camera"></i></div>
            <div class="v-btn" id="btn-record" onclick="toggleRecord()" title="Record Video"><i class="fas fa-video"></i></div>
            <div class="v-btn" onclick="closeVision()" title="Close"><i class="fas fa-times"></i></div>
        </div>
        <div style="position: absolute; top: 10px; width: 100%; text-align: center; z-index: 50; text-shadow: 0 0 5px #000;">
            <div style="font-size: 14px; letter-spacing: 2px; color: var(--primary);" id="vision-status">SYSTEM ONLINE</div>
        </div>
    </div>

    <!-- MODAL: FACE DB -->
    <div id="modal-db" class="modal-window">
        <div class="modal-header"><span>IDENTITY DATABASE</span><i class="fas fa-times" style="font-size: 24px;" onclick="closeModal('modal-db')"></i></div>
        <div class="modal-body">
            <div style="text-align: center;"><img id="db-preview" style="width:120px; height:120px; border-radius:50%; border:2px solid var(--primary); object-fit:cover;"></div>
            <div style="font-size: 12px; color: #888; text-align:center; margin: 5px 0;">MANUAL ENTRY</div>
            <input type="text" id="db-name" placeholder="FULL NAME">
            <select id="db-sex">
                <option value="" disabled selected>SELECT SEX</option>
                <option value="Male">MALE</option>
                <option value="Female">FEMALE</option>
            </select>
            <input type="number" id="db-age" placeholder="AGE">
            <select id="db-access">
                <option value="" disabled selected>ACCESS LEVEL</option>
                <option value="Full">FULL (ADMIN)</option>
                <option value="Medium">MEDIUM (GUEST)</option>
                <option value="None">NONE (UNKNOWN)</option>
                <option value="Missing">MISSING (AMBER ALERT)</option>
            </select>
            <button class="text-btn" id="btn-save-id" onclick="manualSaveIdentity()">SAVE RECORD</button>
            <div style="border-top:1px solid #333; margin-top:20px; padding-top:10px; font-size:12px;">REGISTERED IDENTITIES:</div>
            <div id="db-list" style="display:flex; flex-direction:column; gap:10px;"></div>
            <button class="text-btn" style="margin-top:20px; background:rgba(255,0,0,0.2); border-color:red; color:red;" onclick="clearDB()">WIPE DATABASE</button>
        </div>
    </div>

    <!-- MODAL: COMMS -->
    <div id="modal-comms" class="modal-window">
        <div class="modal-header"><span>SECURE COMMS</span><i class="fas fa-times" style="font-size: 24px;" onclick="closeModal('modal-comms')"></i></div>
        <div class="modal-body">
            <div class="comms-grid">
                <div class="comms-btn" onclick="launchApp('whatsapp://send?text=')"><i class="fab fa-whatsapp comms-icon"></i><span class="comms-label">WHATSAPP</span></div>
                <div class="comms-btn" onclick="launchApp('https://m.me/')"><i class="fab fa-facebook-messenger comms-icon"></i><span class="comms-label">MESSENGER</span></div>
                <div class="comms-btn" onclick="launchApp('https://m.facebook.com/')"><i class="fab fa-facebook-f comms-icon"></i><span class="comms-label">FACEBOOK</span></div>
                <div class="comms-btn" onclick="launchApp('https://www.instagram.com/')"><i class="fab fa-instagram comms-icon"></i><span class="comms-label">INSTAGRAM</span></div>
            </div>
            <div style="margin-top:auto; font-size:10px; color:#666; text-align:center;">ENCRYPTED CHANNELS READY</div>
        </div>
    </div>

    <!-- MODAL: SETTINGS -->
    <div id="modal-settings" class="modal-window">
        <div class="modal-header"><span>CONFIG</span><i class="fas fa-times" style="font-size: 24px;" onclick="closeModal('modal-settings')"></i></div>
        <div class="modal-body">
            <div style="font-size: 12px; color: #888;">GEMINI API KEY</div>
            <input type="password" id="api-key-input" onchange="saveApiKey(this.value)">
            <button class="text-btn" onclick="openModal('modal-db')">MANAGE DATABASE</button>
            <button class="text-btn" onclick="requestFullScreen()">FORCE FULLSCREEN</button>
        </div>
    </div>

    <!-- MODAL: MEDIA -->
    <div id="modal-media" class="modal-window">
        <div class="modal-header"><span>MEDIA LINK</span><i class="fas fa-times" style="font-size: 24px;" onclick="closeModal('modal-media')"></i></div>
        <div class="modal-body">
            <input type="file" id="media-upload" accept="audio/*" multiple onchange="handleMediaSelect(this)" style="display:none;">
            <button class="text-btn" onclick="document.getElementById('media-upload').click()">ADD AUDIO FILES</button>
            <div style="background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid rgba(0,229,255,0.2);">
                <div id="now-playing" style="color: var(--primary); font-size: 12px; margin-bottom: 5px; text-align: center;">NO MEDIA</div>
                <audio id="audio-player" controls style="width:100%; height: 30px; filter: invert(1) hue-rotate(180deg);" crossorigin="anonymous"></audio>
            </div>
            <div id="playlist-container">
                <div style="text-align:center; padding: 20px; color: #444; font-size: 12px;">PLAYLIST EMPTY</div>
            </div>
        </div>
    </div>

    <script>
        /* --- GLOBAL CONSTANTS --- */
        const canvas = document.getElementById('reactor');
        const ctx = canvas.getContext('2d');
        
        let width, height, centerX, centerY, scale, time = 0;
        let animationFrame;
        
        let systemConfig = { apiKey: localStorage.getItem('jarvis_api_key') || '' };
        let facesDB = JSON.parse(localStorage.getItem('jarvis_faces') || '[]');
        
        // STATES
        let visionActive = false;
        let showMenuTrigger = false; 
        let menuOpen = false;        
        let isSystemActive = false;
        let conversationState = "IDLE"; 
        let tempNewUser = {}; 
        let currentUser = { name: "Unknown", permission: "None" }; 
        let hudData = { alpha: 0, beta: 0, gamma: 0, speed: 0, alt: 0, batt: 100 };
        let isListening = false; // NEW: Track mic state
        
        let audioCtx, analyser, dataArray, source, recognition;
        let localStream = null;
        let watchId = null;
        let camFacingMode = 'environment';
        let playlist = []; 
        let currentTrackIndex = -1;
        let mediaRecorder, recordedChunks = [], isRecording = false;
        let faceModel = null;
        let recogModel = null;
        let isModelLoaded = false;
        let pendingEmbedding = null;
        let lockedTarget = { active: false, x: 0, y: 0, identity: null, lastSeen: 0, color: "#888888" };
        let isAnalyzing = false;
        let isDetecting = false; 

        const menuItems = [
            { id: 'vision', label: 'VISION', icon: 'fa-eye', target: 'vision-toggle', angle: -Math.PI * 0.8 }, 
            { id: 'media', label: 'MEDIA', icon: 'fa-folder', target: 'sub-toggle', angle: -Math.PI * 0.5 },   
            { id: 'config', label: 'CONFIG', icon: 'fa-cog', target: 'modal-settings', angle: -Math.PI * 0.2 } 
        ];
        let mediaSubMenuOpen = false;
        const subMenuItems = [
            { id: 'sub-player', label: 'PLAYER', icon: 'fa-music', target: 'modal-media', angle: -Math.PI * 0.65 },
            { id: 'sub-comms', label: 'COMMS', icon: 'fa-comments', target: 'modal-comms', angle: -Math.PI * 0.35 }
        ];
        
        const DB_NAME = 'JarvisMediaDB'; const DB_VERSION = 1; const STORE_NAME = 'tracks';
        let db;

        /* --- HELPER FUNCTIONS --- */
        function sfx(type) { 
            if(!audioCtx) return;
            try {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); 
                osc.connect(gain); gain.connect(audioCtx.destination); 
                if(type === 'startup') { 
                    osc.frequency.setValueAtTime(200, audioCtx.currentTime); 
                    osc.frequency.exponentialRampToValueAtTime(600, audioCtx.currentTime + 0.5); 
                    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.5); 
                    osc.start(); osc.stop(audioCtx.currentTime + 0.5); 
                } else { 
                    osc.frequency.value = 1200; gain.gain.value = 0.05; osc.type = 'square'; 
                    osc.start(); osc.stop(audioCtx.currentTime + 0.05); 
                }
            } catch(e){}
        }

        // --- UPDATED SPEAK WITH HANDOFF ---
        function speak(text) { 
            if (window.speechSynthesis) { 
                // Stop listening to prevent self-trigger
                try { if(recognition) recognition.stop(); } catch(e){}

                const u = new SpeechSynthesisUtterance(text); 
                const voices = speechSynthesis.getVoices(); 
                const brit = voices.find(v => v.name.includes('Great Britain') || v.name.includes('UK') && v.name.includes('Male')); 
                if (brit) u.voice = brit; 
                
                // RESTART MIC AFTER SPEAKING
                u.onend = () => {
                    if (conversationState !== "IDLE") {
                        try { recognition.start(); } catch(e){}
                    }
                };

                speechSynthesis.speak(u); 
            } 
        }

        function speakRandomConfirm() {
            const phrases = ["Right away, Sir.", "Processing.", "On it, Sir.", "Affirmative.", "Executing."];
            speak(phrases[Math.floor(Math.random() * phrases.length)]);
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); sfx('click'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); sfx('close'); }
        function closeAllModals() { document.querySelectorAll('.modal-window').forEach(m => m.classList.remove('active')); }
        
        function toggleVision() { 
            visionActive = !visionActive; 
            const v = document.getElementById('vision-container'); 
            v.style.display = visionActive?'flex':'none'; 
            if(visionActive) {
                startCamera();
                // START DETECTION LOOP
                runDetectionLoop();
            } else {
                stopCamera();
            }
        }
        function closeVision() { visionActive = false; document.getElementById('vision-container').style.display = 'none'; stopCamera(); }
        
        function initMediaDB() { const request = indexedDB.open(DB_NAME, DB_VERSION); request.onupgradeneeded = (e) => { const db = e.target.result; if (!db.objectStoreNames.contains(STORE_NAME)) db.createObjectStore(STORE_NAME, { autoIncrement: true }); }; request.onsuccess = (e) => { db = e.target.result; loadTracksFromDB(); }; }
        function saveTrackToDB(file) { if (!db) return; const t = db.transaction([STORE_NAME], 'readwrite'); t.objectStore(STORE_NAME).add(file); }
        function loadTracksFromDB() { if (!db) return; const t = db.transaction([STORE_NAME], 'readonly'); const r = t.objectStore(STORE_NAME).getAll(); r.onsuccess = () => { if (r.result && r.result.length > 0) { playlist = r.result; renderPlaylist(); speak(`Media Database loaded. ${playlist.length} tracks.`); } }; }
        function clearMediaDB() { if (!db) return; const t = db.transaction([STORE_NAME], 'readwrite'); t.objectStore(STORE_NAME).clear(); playlist = []; renderPlaylist(); speak("Playlist cleared."); }
        
        function handleMediaSelect(input) { const files = Array.from(input.files); if (files.length === 0) return; files.forEach(f => saveTrackToDB(f)); files.forEach(f => playlist.push(f)); renderPlaylist(); if (currentTrackIndex === -1) playTrack(0); }
        function renderPlaylist() { const container = document.getElementById('playlist-container'); container.innerHTML = ''; if(playlist.length === 0) { container.innerHTML = '<div style="text-align:center; padding: 20px; color: #444; font-size: 12px;">PLAYLIST EMPTY</div>'; return; } playlist.forEach((track, index) => { const item = document.createElement('div'); item.className = 'track-item' + (index === currentTrackIndex ? ' active-track' : ''); item.onclick = () => playTrack(index); item.innerHTML = `<div class="track-icon"><i class="fas ${index === currentTrackIndex ? 'fa-volume-up' : 'fa-music'}"></i></div><div style="flex:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${track.name}</div>`; container.appendChild(item); }); }
        function playTrack(index) { if (index < 0 || index >= playlist.length) return; currentTrackIndex = index; const track = playlist[index]; const player = document.getElementById('audio-player'); player.src = URL.createObjectURL(track); player.play(); document.getElementById('now-playing').innerText = track.name.toUpperCase(); renderPlaylist(); const activeEl = document.querySelector('.active-track'); if(activeEl) activeEl.scrollIntoView({ behavior: 'smooth', block: 'center' }); }
        function playNextTrack() { if (currentTrackIndex < playlist.length - 1) playTrack(currentTrackIndex + 1); else playTrack(0); }
        
        function launchApp(url) { 
            speak("Establishing uplink."); 
            if (url.startsWith('http')) { window.open(url, '_blank'); } 
            else { window.location.href = url; }
        }

        function manualSaveIdentity() {
            const name = document.getElementById('db-name').value;
            const sex = document.getElementById('db-sex').value;
            const age = document.getElementById('db-age').value;
            const acc = document.getElementById('db-access').value;
            if(name && sex && age && acc) {
                facesDB.push({ name: name, sex: sex, age: age, permission: acc, embedding: null });
                localStorage.setItem('jarvis_faces', JSON.stringify(facesDB));
                loadFaceDB();
                closeModal('modal-db');
                speak("Identity record saved.");
            } else { speak("Incomplete data."); }
        }
        function deleteUser(index) {
            facesDB.splice(index, 1);
            localStorage.setItem('jarvis_faces', JSON.stringify(facesDB));
            loadFaceDB();
        }
        function loadFaceDB() {
            const list = document.getElementById('db-list');
            list.innerHTML = "";
            facesDB.forEach((p, i) => {
                list.innerHTML += `
                <div class="db-entry">
                    <div class="db-info"><div style="font-weight:bold;">${p.name}</div><div style="font-size:10px; color:var(--primary);">${p.sex} | ${p.age} | ${p.permission}</div></div>
                    <div class="db-actions"><div class="delete-btn" onclick="deleteUser(${i})"><i class="fas fa-trash"></i></div></div>
                </div>`;
            });
        }

        function toggleVoiceInput() { try { recognition.start(); } catch(e) {} }
        function saveApiKey(val) { systemConfig.apiKey = val.trim(); localStorage.setItem('jarvis_api_key', val); }
        async function startCamera() { try { localStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: camFacingMode } }); const video = document.getElementById('local-vision-feed'); video.srcObject = localStream; if(camFacingMode === 'user') video.classList.add('mirrored'); else video.classList.remove('mirrored'); } catch(e) { document.getElementById('local-vision-feed').style.display = 'none'; document.getElementById('cam-error-msg').style.display = 'block'; speak("Visual sensors failing."); } }
        function stopCamera() { if(localStream) { localStream.getTracks().forEach(t => t.stop()); localStream = null; } }
        function toggleCameraSource() { stopCamera(); camFacingMode = (camFacingMode === 'environment') ? 'user' : 'environment'; startCamera(); }
        async function takePhoto() { sfx('click'); const video = document.getElementById('local-vision-feed'); const cvs = document.createElement('canvas'); cvs.width = video.videoWidth; cvs.height = video.videoHeight; const ctx = cvs.getContext('2d'); if(camFacingMode === 'user') { ctx.translate(cvs.width, 0); ctx.scale(-1, 1); } ctx.drawImage(video, 0, 0); const imgData = cvs.toDataURL('image/jpeg'); document.getElementById('db-preview').src = imgData; document.getElementById('db-name').value = ""; document.getElementById('db-relation').value = ""; document.getElementById('modal-db').classList.add('active'); if(isModelLoaded) { document.getElementById('signature-status').innerText = "ANALYZING FACE GEOMETRY..."; document.getElementById('signature-status').style.color = "#FFA500"; const predictions = await faceModel.estimateFaces(cvs, false); if(predictions.length > 0) { const startX = predictions[0].topLeft[0]; const startY = predictions[0].topLeft[1]; const width = predictions[0].bottomRight[0] - startX; const height = predictions[0].bottomRight[1] - startY; tf.tidy(() => { const tensor = tf.browser.fromPixels(cvs); const faceT = tensor.slice([parseInt(startY), parseInt(startX), 0], [parseInt(height), parseInt(width), 3]); const resized = tf.image.resizeBilinear(faceT, [224, 224]); const resultTensor = recogModel.infer(resized, true); pendingEmbedding = resultTensor.arraySync(); }); document.getElementById('signature-status').innerText = "BIOMETRIC SIGNATURE ACQUIRED"; document.getElementById('signature-status').style.color = "#00FF00"; document.getElementById('btn-save-id').disabled = false; } else { document.getElementById('signature-status').innerText = "NO FACE DETECTED. RETRY."; document.getElementById('signature-status').style.color = "red"; document.getElementById('btn-save-id').disabled = true; } } }
        async function toggleRecord() { if(isRecording) { mediaRecorder.stop(); isRecording = false; document.getElementById('btn-record').classList.remove('recording'); speak("Recording saved."); } else { if(!localStream) return; recordedChunks = []; mediaRecorder = new MediaRecorder(localStream); mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); }; mediaRecorder.onstop = () => { const blob = new Blob(recordedChunks, { type: 'video/webm' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.style.display = 'none'; a.href = url; a.download = 'jarvis_recon_' + Date.now() + '.webm'; document.body.appendChild(a); a.click(); setTimeout(() => { document.body.removeChild(a); window.URL.revokeObjectURL(url); }, 100); }; mediaRecorder.start(); isRecording = true; document.getElementById('btn-record').classList.add('recording'); speak("Recording started."); } }

        /* --- INITIALIZATION LOGIC --- */
        window.onload = function() {
            resize();
            draw(); // Start render loop immediately
            
            if(systemConfig.apiKey) document.getElementById('api-key-input').value = systemConfig.apiKey;
            initMediaDB();
            loadFaceDB();
            
            (async () => {
                try {
                    faceModel = await blazeface.load(); 
                    recogModel = await mobilenet.load(); 
                    isModelLoaded = true; 
                    document.getElementById('model-status').innerText = "AI ONLINE";
                } catch(e) { 
                    console.log("AI Init Failed"); 
                    document.getElementById('model-status').innerText = "MANUAL MODE";
                }
            })();
        };

        async function initSystem(event) {
            if(event) event.stopPropagation(); // Stop propagation to handleInput
            
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') await audioCtx.resume();
                
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 64;
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                const audioEl = document.getElementById('audio-player');
                audioEl.onended = playNextTrack;
                try {
                    if(!source && audioEl) {
                        source = audioCtx.createMediaElementSource(audioEl);
                        source.connect(analyser);
                        analyser.connect(audioCtx.destination);
                    }
                } catch(e) { console.log("Audio Route:", e); }

                if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const response = await DeviceOrientationEvent.requestPermission();
                    if (response === 'granted') activateSensors();
                } else {
                    activateSensors();
                }
                
                if('getBattery' in navigator) {
                    navigator.getBattery().then(b => {
                        hudData.batt = Math.round(b.level * 100);
                        b.addEventListener('levelchange', () => { hudData.batt = Math.round(b.level * 100); });
                    });
                }

                if ('wakeLock' in navigator) try { await navigator.wakeLock.request('screen'); } catch (e) {}

                document.getElementById('start-overlay').style.display = 'none';
                isSystemActive = true;
                speak("Welcome back, Jim. System secure.");
                requestFullScreen();
                
                initSpeech();

            } catch(e) {
                alert("Initialization Warning: " + e.message);
                document.getElementById('start-overlay').style.display = 'none';
                isSystemActive = true; 
            }
        }

        function requestFullScreen() { const doc = document.documentElement; if (doc.requestFullscreen) doc.requestFullscreen(); else if (doc.webkitRequestFullscreen) doc.webkitRequestFullscreen(); }
        window.addEventListener('resize', resize);
        
        function resize() { 
            width = window.innerWidth; 
            height = window.innerHeight; 
            canvas.width = width; 
            canvas.height = height; 
            centerX = width / 2; 
            centerY = height / 2; 
            // Scaled slightly smaller to ensure fit in portrait
            scale = Math.min(width, height) * (width < 768 ? 0.30 : 0.22); 
            const arCvs = document.getElementById('vision-ar-canvas'); 
            if(arCvs) { arCvs.width = width; arCvs.height = height; }
        }
        
        function lerp(s, e, a) { return (1 - a) * s + a * e; }

        function activateSensors() {
            if ('geolocation' in navigator) { 
                watchId = navigator.geolocation.watchPosition((pos) => { 
                    let s = pos.coords.speed; 
                    if(s === null || s < 0) s = 0; 
                    hudData.speed = Math.round(s * 3.6); 
                }, (err) => { }, { enableHighAccuracy: true, maximumAge: 0 }); 
            } 
            window.addEventListener('deviceorientation', (e) => {
                hudData.alpha = e.alpha || 0; 
                hudData.beta = e.beta || 0; 
                hudData.gamma = e.gamma || 0; 
            });
        }

        /* --- DRAW LOOP --- */
        function drawReactor(context, x, y, r, t, isBg, colorOverride) {
            let pulseScale = 1.0;
            if(isSystemActive && analyser && dataArray) {
                try {
                    analyser.getByteFrequencyData(dataArray);
                    let avg = 0;
                    for(let i = 0; i < dataArray.length; i++) avg += dataArray[i];
                    avg = avg / dataArray.length;
                    if(avg > 0) pulseScale = 1.0 + (avg / 256) * 0.5;
                } catch(e){}
            }
            if(window.speechSynthesis && window.speechSynthesis.speaking) {
                pulseScale = 1.0 + Math.abs(Math.sin(time * 0.2)) * 0.3;
            }

            let speedColor = '#00E5FF';
            let speed = hudData.speed;
            if(speed > 50 && speed <= 100) speedColor = '#00FF00';
            else if(speed > 100 && speed <= 150) speedColor = '#FFA500';
            else if(speed > 150) speedColor = '#FF0000';
            if(colorOverride) speedColor = colorOverride;

            const secondaryColor = isBg ? 'rgba(0, 229, 255, 0.5)' : speedColor; 
            const orange = '#FFA500';

            context.setTransform(1,0,0,1,0,0); if(isBg) context.clearRect(0,0, width, height); context.translate(x, y);
            
            context.save(); context.rotate(t * 0.0005); 
            for (let i = 0; i < 60; i++) { 
                context.rotate(Math.PI * 2 / 60); context.beginPath(); 
                context.moveTo(r*1.0,0); context.lineTo(r*1.1,0); 
                context.strokeStyle = speedColor; context.lineWidth = 1; context.stroke(); 
            } 
            context.restore();
            
            context.save(); context.rotate(-t * 0.001); 
            context.lineWidth = r * 0.12; 
            context.strokeStyle = secondaryColor; 
            for(let j=0; j<3; j++) { context.beginPath(); context.arc(0, 0, r*0.85, 0, 1.2); context.stroke(); context.rotate(Math.PI*2/3); } 
            context.restore();
            
            context.save(); context.rotate(t * 0.002); 
            context.strokeStyle = speedColor; context.lineWidth = 2; 
            context.beginPath(); context.arc(0,0, r*0.75, 0, Math.PI*2); context.stroke(); 
            context.restore();
            
            // Core Pulse - PULSE WHITE IF LISTENING
            context.save();
            if(isListening) {
                context.rotate(t * 0.05); context.lineWidth = 6; context.strokeStyle = '#FFFFFF'; context.shadowColor = '#FFFFFF'; context.shadowBlur = 20 + Math.sin(time*0.2)*10; 
                context.beginPath(); context.arc(0,0, r*0.65, 0, 2.0); context.stroke(); 
            } else if(showMenuTrigger) {
                context.rotate(t * 0.05); context.lineWidth = 4; context.strokeStyle = '#FFFFFF'; context.shadowColor = '#FFFFFF'; context.shadowBlur = 10; 
                context.beginPath(); context.arc(0,0, r*0.65, 0, 2.0); context.stroke(); 
            } else {
                context.rotate(-t * 0.003); context.lineWidth = r * 0.1; context.strokeStyle = speedColor; for(let l=0; l<2; l++) { context.beginPath(); context.arc(0,0, r*0.65, 0, 2.0); context.stroke(); context.rotate(Math.PI); } 
            }
            context.restore();
            
            context.save(); 
            context.rotate(t * 0.01); 
            context.lineWidth = 6 * pulseScale; 
            context.strokeStyle = orange; 
            context.shadowColor = orange; 
            context.shadowBlur = 15 * pulseScale; 
            context.beginPath(); context.arc(0,0, r*0.55, 0, 2.0); context.stroke(); 
            context.restore();

            context.save(); context.rotate(t * 0.02); context.lineWidth = 3; context.strokeStyle = '#FFFFFF'; context.shadowColor = '#FFFFFF'; context.shadowBlur = 10; context.beginPath(); context.arc(0,0, r*0.45, 0, Math.PI*2); context.stroke(); context.restore();
        }

        async function draw() {
            try {
                time++; 
                animationFrame = requestAnimationFrame(draw);
                ctx.setTransform(1, 0, 0, 1, 0, 0);
                ctx.clearRect(0,0, width, height);

                if(!visionActive) { 
                    drawReactor(ctx, centerX, centerY, scale * 0.9, time, true); 
                    drawHUDData(ctx, centerX, centerY, scale * 0.9);
                    if(showMenuTrigger) drawMenuTrigger(ctx, centerX, centerY, scale);
                    if(menuOpen) drawMenu(ctx, centerX, centerY, scale);
                }

                if(visionActive) {
                    const arCvs = document.getElementById('vision-ar-canvas'); 
                    if(arCvs && isModelLoaded) {
                        const arCtx = arCvs.getContext('2d');
                        arCtx.setTransform(1,0,0,1,0,0); arCtx.clearRect(0,0, arCvs.width, arCvs.height);
                        
                        // DRAW TARGET IF ACTIVE
                        if(lockedTarget.active) {
                            const lostTime = time - lockedTarget.lastSeen;
                            if(lostTime < 300) {
                                lockedTarget.x = lerp(lockedTarget.x, lockedTarget.targetX, 0.15);
                                lockedTarget.y = lerp(lockedTarget.y, lockedTarget.targetY, 0.15);
                                
                                let alpha = 1.0;
                                if(lostTime > 180) alpha = 1.0 - ((lostTime - 180) / 120); 
                                
                                arCtx.globalAlpha = alpha;
                                
                                const tr = 150; 
                                arCtx.translate(lockedTarget.x, lockedTarget.y);
                                
                                drawLockRing(arCtx, tr, lockedTarget.color);
                                
                                arCtx.fillStyle = lockedTarget.color;
                                arCtx.font = "bold 16px Share Tech Mono";
                                arCtx.textAlign = "left";
                                arCtx.fillText(lockedTarget.info.top, tr + 10, -10);
                                arCtx.font = "12px Share Tech Mono";
                                arCtx.fillText(lockedTarget.info.bottom, tr + 10, 10);
                                arCtx.resetTransform();
                                arCtx.globalAlpha = 1.0;
                            } else {
                                lockedTarget.active = false;
                            }
                        }
                    }
                }
            } catch(e) { console.error("Draw Loop Error:", e); }
        }

        async function runDetectionLoop() {
            if(!visionActive) return;
            if(isDetecting) {
                requestAnimationFrame(runDetectionLoop);
                return;
            }
            isDetecting = true;
            
            const video = document.getElementById('local-vision-feed');
            if(video && video.readyState === 4 && faceModel) {
                 const predictions = await faceModel.estimateFaces(video, false);
                 if(predictions.length > 0) {
                     const pred = predictions[0];
                     const start = pred.topLeft; const end = pred.bottomRight;
                     const size = [end[0] - start[0], end[1] - start[1]];
                     
                     const arCvs = document.getElementById('vision-ar-canvas');
                     const scaleX = arCvs.width / video.videoWidth;
                     const scaleY = arCvs.height / video.videoHeight;
                     
                     const x = start[0] * scaleX;
                     const y = start[1] * scaleY;
                     const w = size[0] * scaleX;
                     const h = size[1] * scaleY;
                     
                     lockedTarget.targetX = x + w/2;
                     lockedTarget.targetY = y + h/2;
                     lockedTarget.lastSeen = time;
                     lockedTarget.active = true;
                     
                     if(!isAnalyzing && (time % 30 === 0)) {
                         isAnalyzing = true;
                         identifyFace(video, pred);
                     }
                 }
            }
            
            isDetecting = false;
            requestAnimationFrame(runDetectionLoop);
        }

        function drawHUDData(ctx, cx, cy, s) {
            let speedColor = '#00E5FF';
            let speed = hudData.speed;
            if(speed > 50 && speed <= 100) speedColor = '#00FF00';
            else if(speed > 100 && speed <= 150) speedColor = '#FFA500';
            else if(speed > 150) speedColor = '#FF0000';

            // Compass
            ctx.setTransform(1,0,0,1,0,0); ctx.translate(cx, cy); ctx.save();
            ctx.rotate(-hudData.alpha * (Math.PI / 180));
            ctx.fillStyle = speedColor; ctx.font = `bold ${s*0.25}px Share Tech Mono`;
            ctx.globalAlpha = 0.8; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ['N','E','S','W'].forEach((d,i) => {
                ctx.save(); ctx.rotate(i*Math.PI/2); ctx.translate(0, -s*1.45); ctx.rotate(-i*Math.PI/2); ctx.fillText(d,0,0); ctx.restore();
            });
            ctx.restore();

            // Horizon
            ctx.save(); ctx.rotate(-hudData.gamma * (Math.PI / 180));
            const pitchY = hudData.beta * 3;
            ctx.translate(0, pitchY);
            ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 3; ctx.shadowBlur = 10; ctx.shadowColor = speedColor;
            ctx.beginPath(); ctx.moveTo(-s*0.6, 0); ctx.lineTo(s*0.6, 0); ctx.stroke();
            // Pitch Ladder
            ctx.lineWidth = 1; ctx.globalAlpha = 0.3;
            for(let i=1; i<=2; i++) { 
                ctx.beginPath(); ctx.moveTo(-s*0.2, -i*40); ctx.lineTo(s*0.2, -i*40); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-s*0.2, i*40); ctx.lineTo(s*0.2, i*40); ctx.stroke();
            }
            ctx.restore();

            // Speed
            ctx.shadowBlur = 0; ctx.fillStyle = '#FFFFFF'; ctx.globalAlpha = 1.0;
            ctx.font = `900 ${s*0.6}px Orbitron`; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
            ctx.fillText(hudData.speed, 0, 10);
            ctx.font = `bold ${s*0.15}px Share Tech Mono`; ctx.fillStyle = speedColor;
            ctx.fillText("KM/H", 0, s*0.45);

            // Left Pitch
            ctx.setTransform(1,0,0,1,0,0); ctx.translate(20, cy); ctx.save();
            ctx.rotate(-hudData.gamma * (Math.PI / 180)); ctx.translate(0, hudData.beta * 4);
            ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 2; ctx.globalAlpha = 0.6;
            for(let i=-3; i<=3; i++) {
                let w = (i===0) ? 30 : 15;
                ctx.beginPath(); ctx.moveTo(-w/2, i*40); ctx.lineTo(w/2, i*40); ctx.stroke();
            }
            ctx.restore();

            // Top Right Battery - Adjusted Position
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.globalAlpha = 0.8;
            ctx.font = `12px Share Tech Mono`;
            ctx.fillStyle = hudData.batt < 20 ? '#FF0000' : '#00E5FF';
            ctx.textAlign = 'right';
            ctx.fillText(`${hudData.batt}%`, width - 60, 25); 
            ctx.fillRect(width - 50, 15, 30 * (hudData.batt/100), 10);
            ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 1; ctx.strokeRect(width-50, 15, 30, 10);
        }

        function drawMenuTrigger(ctx, cx, cy, s) {
            const btnY = s * 1.1; 
            ctx.setTransform(1,0,0,1,0,0); ctx.translate(cx, cy);
            ctx.fillStyle = "rgba(0, 20, 40, 0.9)"; ctx.strokeStyle = "#00E5FF"; ctx.lineWidth = 2;
            ctx.beginPath();
            const x = -40, y = btnY, w = 80, h = 40, r = 10;
            ctx.moveTo(x+r, y); ctx.arcTo(x+w, y, x+w, y+h, r); ctx.arcTo(x+w, y+h, x, y+h, r); ctx.arcTo(x, y+h, x, y, r); ctx.arcTo(x, y, x+w, y, r);
            ctx.closePath();
            ctx.fill(); ctx.stroke();
            ctx.fillStyle = "#FFFFFF"; ctx.font = "bold 14px Orbitron"; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText("MENU", 0, btnY + 20);
        }

        function drawMenu(ctx, cx, cy, s) {
            menuItems.forEach(item => {
                const outerR = s * 1.6; const innerR = s * 1.35; 
                const angleWidth = 0.25; const startAngle = item.angle - angleWidth; const endAngle = item.angle + angleWidth;
                ctx.setTransform(1,0,0,1,0,0); ctx.translate(cx, cy);
                ctx.beginPath(); ctx.arc(0, 0, outerR, startAngle, endAngle); ctx.arc(0, 0, innerR, endAngle, startAngle, true); ctx.closePath();
                ctx.fillStyle = (item.target === 'sub-toggle' && mediaSubMenuOpen) ? "rgba(0, 229, 255, 0.3)" : "rgba(0, 10, 20, 0.95)";
                ctx.strokeStyle = '#00E5FF'; ctx.lineWidth = 2; ctx.fill(); ctx.stroke();
                const midR = (outerR + innerR) / 2; 
                const txtX = Math.cos(item.angle) * midR; const txtY = Math.sin(item.angle) * midR;
                ctx.fillStyle = "#00E5FF"; ctx.font = `bold ${s * 0.08}px Orbitron`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; 
                ctx.fillText(item.label, txtX, txtY); 
            });
            if (mediaSubMenuOpen) {
                subMenuItems.forEach(item => {
                    const outerR = s * 1.3; const innerR = s * 1.05; 
                    const angleWidth = 0.15; const startAngle = item.angle - angleWidth; const endAngle = item.angle + angleWidth;
                    ctx.setTransform(1,0,0,1,0,0); ctx.translate(cx, cy);
                    ctx.beginPath(); ctx.arc(0, 0, outerR, startAngle, endAngle); ctx.arc(0, 0, innerR, endAngle, startAngle, true); ctx.closePath();
                    ctx.fillStyle = "rgba(0, 40, 60, 0.9)"; ctx.strokeStyle = '#00E5FF'; ctx.lineWidth = 1; ctx.fill(); ctx.stroke();
                    const midR = (outerR + innerR) / 2; 
                    const txtX = Math.cos(item.angle) * midR; const txtY = Math.sin(item.angle) * midR;
                    ctx.fillStyle = "#00E5FF"; ctx.font = `bold ${s * 0.06}px Orbitron`; ctx.textAlign = "center"; ctx.textBaseline = "middle"; 
                    ctx.fillText(item.label, txtX, txtY); 
                });
            }
        }

        // --- NEW TARGET LOCK UI ---
        function drawLockRing(ctx, r, color) {
            // Layer 1: Outer Ticks (Faster rotation)
            ctx.save();
            ctx.rotate(time * 0.05);
            for (let i = 0; i < 60; i++) {
                ctx.rotate(Math.PI * 2 / 60);
                ctx.beginPath();
                ctx.moveTo(r, 0);
                ctx.lineTo(r * 1.1, 0);
                ctx.strokeStyle = color;
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            ctx.restore();

            // Layer 2: Mid Arcs (Counter-rotate, transparent)
            ctx.save();
            ctx.rotate(-time * 0.02);
            ctx.lineWidth = r * 0.12;
            ctx.strokeStyle = color;
            ctx.globalAlpha = 0.5;
            for(let j=0; j<3; j++) {
                ctx.beginPath();
                ctx.arc(0, 0, r * 0.85, 0, 1.2);
                ctx.stroke();
                ctx.rotate(Math.PI*2/3);
            }
            ctx.restore();

            // Layer 3: Inner Solid Ring
            ctx.save();
            ctx.rotate(time * 0.02);
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(0, 0, r * 0.75, 0, Math.PI*2);
            ctx.stroke();
            ctx.restore();

            // Layer 4: Core Segments (Face Box)
            ctx.save();
            ctx.rotate(-time * 0.05);
            ctx.lineWidth = r * 0.05;
            ctx.strokeStyle = color;
            for(let l=0; l<2; l++) {
                ctx.beginPath();
                ctx.arc(0,0, r * 0.65, 0, 2.0);
                ctx.stroke();
                ctx.rotate(Math.PI);
            }
            ctx.restore();
        }
        
        async function identifyFace(video, pred) {
            if(facesDB.length === 0) {
                lockedTarget.color = "#888"; lockedTarget.info = { top: "UNKNOWN", bottom: "NO DATABASE" };
                currentUser = { name: "Unknown", permission: "None" };
                isAnalyzing = false; return;
            }

            const start = pred.topLeft; const end = pred.bottomRight;
            const tensor = tf.tidy(() => {
                const vidT = tf.browser.fromPixels(video);
                const faceT = vidT.slice([parseInt(start[1]), parseInt(start[0]), 0], [parseInt(end[1] - start[1]), parseInt(end[0] - start[0]), 3]);
                const resized = tf.image.resizeBilinear(faceT, [224, 224]);
                return recogModel.infer(resized, true);
            });
            
            let bestMatch = { diff: 100, entry: null };
            for(let entry of facesDB) {
                if(!entry.embedding) continue;
                const dbT = tf.tensor(entry.embedding);
                const dist = tf.tidy(() => tensor.sub(dbT).pow(2).sum().sqrt().dataSync()[0]);
                dbT.dispose();
                if(dist < bestMatch.diff) bestMatch = { diff: dist, entry: entry };
            }
            tensor.dispose();

            // INCREASED THRESHOLD FOR MOBILE CAMERAS
            if(bestMatch.diff < 25.0) { 
                const p = bestMatch.entry;
                currentUser = p;
                lockedTarget.info = { top: p.name.toUpperCase(), bottom: `${p.sex} | ${p.age}` };
                
                if(p.permission === 'Full') { lockedTarget.color = "#00FF00"; lockedTarget.info.bottom += " | ADMIN"; }
                else if(p.permission === 'Medium') { lockedTarget.color = "#FFFF00"; lockedTarget.info.bottom += " | LIMITED"; }
                else if(p.permission === 'Missing') { lockedTarget.color = "#00E5FF"; lockedTarget.info.bottom = "AMBER ALERT"; }
                else { lockedTarget.color = "#888"; lockedTarget.info.bottom += " | NO ACCESS"; }
                
            } else {
                currentUser = { name: "Unknown", permission: "None" };
                lockedTarget.color = "#888";
                lockedTarget.info = { top: "UNKNOWN", bottom: "ACCESS DENIED" };
            }
            isAnalyzing = false;
        }

        function handleInput(e) { 
            if(!isSystemActive) return;
            if(visionActive || document.querySelector('.modal-window.active')) return; 
            
            const cx = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
            const cy = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
            
            const rect = canvas.getBoundingClientRect();
            const dx = cx - (rect.left + centerX); 
            const dy = cy - (rect.top + centerY); 
            const dist = Math.sqrt(dx*dx + dy*dy); 
            const angle = Math.atan2(dy, dx); 

            const btnY = scale * 1.1; 
            if (showMenuTrigger && Math.abs(dx) < 60 && Math.abs(dy - (btnY + 20)) < 50) {
                e.preventDefault(); sfx('click');
                menuOpen = !menuOpen;
                return;
            }

            if (dist < scale * 0.6) {
                e.preventDefault(); sfx('click');
                showMenuTrigger = true; 
                speakRandomConfirm();   
                try { recognition.start(); } catch(e) {}
                setTimeout(() => { showMenuTrigger = false; }, 15000); 
                return;
            }

            if (menuOpen && dist > scale * 1.35 && dist < scale * 1.6) { 
                menuItems.forEach(item => { 
                    let diff = angle - item.angle; 
                    while(diff < -Math.PI) diff += Math.PI*2; while(diff > Math.PI) diff -= Math.PI*2; 
                    if (Math.abs(diff) < 0.25) { 
                        e.preventDefault(); sfx('click'); 
                        if(item.target === 'vision-toggle') toggleVision(); 
                        else if(item.target === 'hud-launch') activateHUD();
                        else if(item.target === 'sub-toggle') { mediaSubMenuOpen = !mediaSubMenuOpen; } 
                        else openModal(item.target); 
                    } 
                }); 
            }
            
            if (menuOpen && mediaSubMenuOpen && dist > scale * 1.05 && dist < scale * 1.3) {
                subMenuItems.forEach(item => {
                    let diff = angle - item.angle; 
                    while(diff < -Math.PI) diff += Math.PI*2; while(diff > Math.PI) diff -= Math.PI*2; 
                    if (Math.abs(diff) < 0.15) { 
                        e.preventDefault(); sfx('click'); openModal(item.target); 
                    }
                });
            }
        }

        window.addEventListener('touchstart', handleInput, {passive: false}); 
        window.addEventListener('mousedown', handleInput);

        /* --- DB MANAGEMENT --- */
        function manualSaveIdentity() {
            const name = document.getElementById('db-name').value;
            const sex = document.getElementById('db-sex').value;
            const age = document.getElementById('db-age').value;
            const acc = document.getElementById('db-access').value;
            
            if(name && sex && age && acc) {
                facesDB.push({ name: name, sex: sex, age: age, permission: acc, embedding: null });
                localStorage.setItem('jarvis_faces', JSON.stringify(facesDB));
                loadFaceDB();
                closeModal('modal-db');
                speak("Identity record saved.");
            } else {
                speak("Incomplete data.");
            }
        }

        function deleteUser(index) {
            facesDB.splice(index, 1);
            localStorage.setItem('jarvis_faces', JSON.stringify(facesDB));
            loadFaceDB();
        }

        function loadFaceDB() {
            const list = document.getElementById('db-list');
            list.innerHTML = "";
            facesDB.forEach((p, i) => {
                list.innerHTML += `
                <div class="db-entry">
                    <div class="db-info">
                        <div style="font-weight:bold;">${p.name}</div>
                        <div style="font-size:10px; color:var(--primary);">${p.sex} | ${p.age} | ${p.permission}</div>
                    </div>
                    <div class="db-actions">
                        <div class="delete-btn" onclick="deleteUser(${i})"><i class="fas fa-trash"></i></div>
                    </div>
                </div>`;
            });
        }

        // --- SPEECH COMMANDS ---
        function initSpeech() { 
            const SR = window.SpeechRecognition || window.webkitSpeechRecognition; 
            if(!SR) return; 
            recognition = new SR(); 
            recognition.continuous = false; 
            recognition.interimResults = false;
            recognition.lang = 'en-US'; 
            
            recognition.onstart = () => { isListening = true; }; // Visual Pulse
            recognition.onend = () => {
                isListening = false; 
                if(conversationState !== "IDLE") {
                    try { recognition.start(); } catch(e){}
                }
            };

            recognition.onresult = (e) => { 
                const t = e.results[0][0].transcript.toLowerCase().trim();
                console.log("Command:", t);
                processVoiceCommand(t);
            };
        }

        function processVoiceCommand(t) {
            if(conversationState === "IDLE") {
                if(t.includes("scan person") || t.includes("scan target")) {
                    speak("Scanning target.");
                    conversationState = "SCANNING"; // Prevent Mic Cutoff
                    captureAndEnroll();
                    return;
                }
                
                if(currentUser.permission === 'None' || currentUser.permission === 'Medium') {
                     if(t.includes("open") || t.includes("close") || t.includes("play")) {
                         speak("Access denied.");
                         return;
                     }
                }

                if(t.includes('vision') || t.includes('camera')) { speakRandomConfirm(); if(!visionActive) toggleVision(); }
                else if(t.includes('close vision')) { speakRandomConfirm(); if(visionActive) closeVision(); }
                else if(t.includes('media') || t.includes('music')) { speakRandomConfirm(); openModal('modal-media'); }
                else if(t.includes('close')) { speakRandomConfirm(); closeAllModals(); }
                else if(t.includes('comms')) { speakRandomConfirm(); openModal('modal-comms'); }
                else if(t.includes('whatsapp')) { launchApp('whatsapp://send?text='); }
                else if(t.includes('facebook')) { launchApp('https://m.facebook.com/'); }
                else if(t.includes('messenger')) { launchApp('https://m.me/'); }
                else if(t.includes('instagram')) { launchApp('https://www.instagram.com/'); }
                else if(t.includes('play')) { 
                    const player = document.getElementById('audio-player');
                    if (playlist.length > 0) {
                        if(!player.src || player.src === "") playTrack(0); else player.play();
                    } else { speak("Playlist empty."); }
                }
                else if(t.includes('pause') || t.includes('stop')) { document.getElementById('audio-player').pause(); }
                else if(t.includes('next') || t.includes('skip')) { playNextTrack(); }
                else if(t.includes('database')) { speakRandomConfirm(); openModal('modal-db'); }
                else if(t.includes('full screen')) { requestFullScreen(); }
            }
            
            else if(conversationState === "SCAN_CONFIRM") {
                if(t.includes("yes")) {
                    conversationState = "ASK_NAME";
                    speak("Who is this person, Sir?");
                } else {
                    conversationState = "IDLE";
                    speak("Scan discarded.");
                }
            }
            
            else if(conversationState === "ASK_NAME") {
                if(t.length > 0) {
                    tempNewUser.name = t.toUpperCase();
                    conversationState = "ASK_SEX";
                    speak("Is it a male or female?");
                }
            }
            
            else if(conversationState === "ASK_SEX") {
                if(t.includes("female")) tempNewUser.sex = "Female";
                else tempNewUser.sex = "Male";
                conversationState = "ASK_AGE";
                speak("How old is that person?");
            }
            
            else if(conversationState === "ASK_AGE") {
                let age = t.replace(/\D/g,'');
                if(age) {
                    tempNewUser.age = age;
                    conversationState = "ASK_ACCESS";
                    speak("What level of access? Full, Medium, or None?");
                }
            }
            
            else if(conversationState === "ASK_ACCESS") {
                if(t.includes("full")) tempNewUser.permission = "Full";
                else if(t.includes("medium")) tempNewUser.permission = "Medium";
                else if(t.includes("missing")) tempNewUser.permission = "Missing";
                else tempNewUser.permission = "None";
                
                facesDB.push(tempNewUser);
                localStorage.setItem('jarvis_faces', JSON.stringify(facesDB));
                loadFaceDB();
                conversationState = "IDLE";
                speak("Identity registered. Permissions updated.");
            }
        }

        async function captureAndEnroll() {
            if(!visionActive) {
                toggleVision();
                await new Promise(r => setTimeout(r, 2000)); 
            }
            
            const video = document.getElementById('local-vision-feed');
            const preds = await faceModel.estimateFaces(video, false);
            
            if(preds.length > 0) {
                const pred = preds[0];
                const start = pred.topLeft; const end = pred.bottomRight;
                
                const tensor = tf.tidy(() => {
                    const vidT = tf.browser.fromPixels(video);
                    const faceT = vidT.slice([parseInt(start[1]), parseInt(start[0]), 0], [parseInt(end[1] - start[1]), parseInt(end[0] - start[0]), 3]);
                    const resized = tf.image.resizeBilinear(faceT, [224, 224]);
                    return recogModel.infer(resized, true);
                });
                
                tempNewUser = { embedding: tensor.arraySync() };
                tensor.dispose();
                
                conversationState = "SCAN_CONFIRM";
                speak("Scan complete. Shall I add this person to the database?");
            } else {
                speak("No face detected.");
                conversationState = "IDLE";
            }
        }

        function toggleVoiceInput() { try { recognition.start(); } catch(e) {} }
        function saveApiKey(val) { systemConfig.apiKey = val.trim(); localStorage.setItem('jarvis_api_key', val); }
    </script>
</body>
</html>
