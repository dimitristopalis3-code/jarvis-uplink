<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline' 'unsafe-eval' data: blob:;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#050a14">
    <meta name="mobile-web-app-capable" content="yes">
    <title>JARVIS: MOBILE UNIT</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* --- CORE MOBILE STYLES --- */
        * { -webkit-tap-highlight-color: transparent; user-select: none; box-sizing: border-box; touch-action: none; }
        html { background: #050a14; height: 100%; }
        body { 
            margin: 0; overflow: hidden; 
            background-color: #050a14; 
            font-family: 'Orbitron', sans-serif; 
            color: #00E5FF; 
            height: 100vh; width: 100vw; 
            display: flex; justify-content: center; align-items: center; 
        }
        
        /* REACTOR CONTAINER - RESTORED */
        #reactor-container { 
            position: fixed; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            width: 100vw; 
            height: 100vh; 
            z-index: 0; 
            opacity: 0.8; 
            background: radial-gradient(circle, rgba(0,0,0,0) 20%, rgba(5, 10, 20, 0.4) 100%); 
            pointer-events: none; /* Let touches pass to buttons */
        }
        canvas { display: block; }
        
        /* CORE VISION OVERLAY */
        #core-vision-overlay {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 50%; overflow: hidden; z-index: 10; 
            display: none; background: #000; border: 2px solid #00E5FF;
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.5);
            pointer-events: auto;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #core-vision-overlay.core-expanded {
            width: 90vw !important; height: 90vw !important;
            border: 4px solid #FFA500; 
            box-shadow: 0 0 80px rgba(255, 165, 0, 0.6);
            z-index: 100; border-radius: 20px;
        }
        #core-vision-overlay video { width: 100%; height: 100%; object-fit: cover; }
        
        .vision-controls {
            position: absolute; bottom: 10px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px; pointer-events: none;
        }
        .vision-btn {
            pointer-events: auto; background: rgba(0,0,0,0.6); border: 1px solid #00E5FF; color: #00E5FF;
            border-radius: 50%; width: 45px; height: 45px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 18px;
        }

        /* UI OVERLAYS */
        #overlay-text { position: absolute; bottom: 20px; width: 100%; text-align: center; color: #00bcd4; font-size: 10px; opacity: 0.6; z-index: 5; pointer-events: none; }
        #mic-status { position: absolute; top: 30px; width: 100%; text-align: center; color: rgba(0, 229, 255, 0.7); font-size: 12px; letter-spacing: 3px; z-index: 5; font-weight: 700; pointer-events: none; }
        
        /* INIT OVERLAY */
        #start-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(5, 10, 20, 0.95); z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            pointer-events: auto;
        }
        #start-btn { 
            padding: 20px 40px; border: 2px solid #00E5FF; background: rgba(0, 229, 255, 0.1); 
            color: #00E5FF; font-family: 'Orbitron'; font-size: 20px; font-weight: 900; letter-spacing: 2px; 
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.2); 
        }

        /* WINDOWS */
        .modal-window { 
            position: absolute; background: rgba(10, 15, 25, 0.95); border: 1px solid #00E5FF; 
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.15); backdrop-filter: blur(15px); padding: 0; 
            display: none; flex-direction: column; z-index: 50; pointer-events: auto;
            width: 95%; height: 85%; top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .modal-header { background: rgba(0, 229, 255, 0.15); padding: 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #00E5FF; flex-shrink: 0; }
        .modal-title { font-size: 14px; font-weight: bold; text-shadow: 0 0 5px #00E5FF; }
        .close-btn { font-size: 24px; padding: 0 10px; color: #00E5FF; }
        .modal-body { flex: 1; padding: 15px; overflow-y: auto; color: #ccc; display: flex; flex-direction: column; gap: 10px; }

        /* INPUTS & BUTTONS */
        .input-group { display: flex; gap: 5px; flex-shrink: 0; }
        input[type="text"], select { 
            background: rgba(0, 20, 30, 0.9); border: 1px solid #00E5FF; color: #00E5FF; 
            padding: 10px; flex: 1; outline: none; font-family: 'Orbitron'; font-size: 16px; min-height: 40px; 
        }
        button { 
            background: rgba(0, 229, 255, 0.1); color: #00E5FF; border: 1px solid #00E5FF; 
            padding: 10px; font-family: 'Orbitron'; min-height: 44px; transition: 0.2s; 
        }
        button:active { background: #00E5FF; color: #000; }

        .chat-log { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 12px; line-height: 1.4; font-family: 'Consolas', monospace; color: #aaa; }
        .setting-row { margin-bottom: 15px; display: flex; align-items: center; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px; }
        
        .mic-active { color: #FFA500 !important; text-shadow: 0 0 20px #FFA500; animation: pulse 1.5s infinite; }
    </style>
</head>
<body>

    <div id="start-overlay" onclick="initSystem()">
        <div id="start-btn">INITIALIZE MOBILE</div>
        <div style="margin-top: 15px; opacity: 0.7; font-size: 10px;">CORE RESTORED v72.0</div>
    </div>

    <!-- REACTOR CONTAINER RESTORED -->
    <div id="reactor-container"><canvas id="reactor"></canvas></div>
    
    <!-- INTEGRATED CORE VISION -->
    <div id="core-vision-overlay" onclick="toggleCoreZoom()">
        <video id="local-vision-feed" autoplay playsinline muted></video>
        <div class="vision-controls">
            <div class="vision-btn" onclick="event.stopPropagation(); switchCameraFacing()" title="Switch Cam"><i class="fas fa-sync-alt"></i></div>
            <div class="vision-btn" onclick="event.stopPropagation(); toggleVisionMode()" title="Close"><i class="fas fa-times"></i></div>
        </div>
    </div>

    <div id="mic-status">AWAITING INITIALIZATION</div>
    <div id="overlay-text">SYSTEM ONLINE</div>

    <!-- CHAT CONSOLE -->
    <div id="modal-command" class="modal-window">
        <div class="modal-header">
            <span class="modal-title">MAIN CONSOLE</span>
            <span class="close-btn" onclick="closeModal('modal-command')">×</span>
        </div>
        <div class="modal-body">
            <div class="chat-log" id="chat-log">> SYSTEM: CORE VISUALS RESTORED.<br>> SYSTEM: READY.<br></div>
            <div class="input-group">
                <input type="text" id="chat-input" placeholder="Ask Jarvis..." onkeydown="handleChat(event)">
                <button onclick="toggleVoiceInput()"><i class="fas fa-microphone"></i></button>
            </div>
        </div>
    </div>

    <!-- SETTINGS -->
    <div id="modal-settings" class="modal-window">
        <div class="modal-header">
            <span class="modal-title">SYSTEM CONFIG</span>
            <span class="close-btn" onclick="closeModal('modal-settings')">×</span>
        </div>
        <div class="modal-body">
            <div class="setting-row"><span>GEMINI KEY</span><input type="password" id="api-key-input" onchange="saveApiKey(this.value)"></div>
            <div class="setting-row"><span>VOICE</span><select id="voice-select" onchange="saveVoiceSelection(this)"></select></div>
            <button onclick="testVoice()" style="width:100%; margin-top: auto;">TEST AUDIO</button>
        </div>
    </div>

    <script>
        // --- CORE VARIABLES ---
        const canvas = document.getElementById('reactor');
        const ctx = canvas.getContext('2d');
        let width, height, centerX, centerY, scale, time = 0;
        let mouse = { x: 0, y: 0 }; 
        
        // State
        let userApiKey = "";
        let systemState = 'IDLE', micEnabled = false;
        let batteryLevel = 1.0;
        let voices = [], recognition = null, silenceTimer = null;
        
        let visionActive = false, isCoreExpanded = false;
        let currentFacingMode = 'environment'; 
        let localStream = null;
        let audioCtx, analyser, dataArray, audioPlayer;

        const colors = { cyan: '#00E5FF', darkCyan: 'rgba(0, 229, 255, 0.15)', orange: '#FFA500', bg: '#050a14', white: '#FFFFFF' };
        const menuItems = [
            { id: 'set', label: 'CONFIG', icon: '\uf013', targetModal: 'modal-settings', angle: -Math.PI * 0.25, opacity: 0.4, hovered: false }, 
            { id: 'vis', label: 'VISION', icon: '\uf06e', targetModal: 'core-vision', angle: Math.PI * 0.25, opacity: 0.4, hovered: false }, 
            { id: 'cmd', label: 'CHAT', icon: '\uf086', targetModal: 'modal-command', angle: Math.PI * 0.75, opacity: 0.4, hovered: false },
        ];

        // --- INIT ---
        async function initSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                initAudioEngine();
                sfxOpen();
            } catch(e) { console.log("Audio Init Failed"); }

            if ('wakeLock' in navigator) { try { await navigator.wakeLock.request('screen'); } catch (err) {} }

            loadMemory();
            populateVoices();
            micEnabled = true;
            startContinuousListening();
            
            speak("Mobile Unit Initialized.");
            
            // Force Visuals
            resize();
            draw();
        }

        function loadMemory() {
            const k = localStorage.getItem('jarvis_api_key'); if(k) { userApiKey = k; document.getElementById('api-key-input').value = k; }
        }
        function saveApiKey(k) { userApiKey = k.trim(); localStorage.setItem('jarvis_api_key', userApiKey); }
        function saveVoiceSelection(e) { const n = e.options[e.selectedIndex].getAttribute('data-name'); if(n) localStorage.setItem('jarvis_voice_name', n); }

        // --- VISION LOGIC ---
        async function toggleVisionMode() {
            visionActive = !visionActive;
            const core = document.getElementById('core-vision-overlay');
            isCoreExpanded = false; core.classList.remove('core-expanded');
            
            if (visionActive) {
                core.style.display = 'block';
                startCamera();
            } else {
                core.style.display = 'none';
                stopCamera();
            }
            resize(); 
        }

        async function startCamera() {
            stopCamera(); 
            const video = document.getElementById('local-vision-feed');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
                localStream = stream;
                video.srcObject = stream;
            } catch(e) { alert("Camera failed: " + e); }
        }

        function stopCamera() {
            if (localStream) { localStream.getTracks().forEach(track => track.stop()); localStream = null; }
        }

        function switchCameraFacing() {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            startCamera();
        }

        function toggleCoreZoom() {
            const core = document.getElementById('core-vision-overlay');
            isCoreExpanded = !isCoreExpanded;
            if (isCoreExpanded) core.classList.add('core-expanded');
            else core.classList.remove('core-expanded');
        }

        // --- UI ---
        function openModal(id) { 
            sfxOpen();
            if (id === 'core-vision') { toggleVisionMode(); return; }
            document.querySelectorAll('.modal-window').forEach(w => w.style.display='none');
            document.getElementById(id).style.display = 'flex';
        }

        function closeModal(id) { sfxClick(); document.getElementById(id).style.display='none'; }

        function toggleVoiceInput() {
            wakeUp();
            document.getElementById('chat-log').innerHTML += "<br>> LISTENING...";
        }

        // --- AUDIO ---
        function populateVoices() {
            voices = speechSynthesis.getVoices();
            const s = document.getElementById('voice-select'); s.innerHTML = '';
            if (voices.length === 0) { s.add(new Option("Loading...")); setTimeout(populateVoices, 100); return; }
            const sv = localStorage.getItem('jarvis_voice_name');
            voices.forEach(v => { 
                const o = new Option(v.name); o.setAttribute('data-name', v.name);
                if (v.name === sv) o.selected = true; s.add(o); 
            });
        }
        speechSynthesis.onvoiceschanged = populateVoices;

        function speak(text) {
            try {
                speechSynthesis.cancel();
                isSpeaking = true;
                const u = new SpeechSynthesisUtterance(text);
                const n = localStorage.getItem('jarvis_voice_name');
                if (voices.length > 0) { const v = voices.find(x => x.name === n); if (v) u.voice = v; }
                u.onend = () => { isSpeaking = false; if(!isAwake) resetSilenceTimer(); };
                speechSynthesis.speak(u);
            } catch(e) {}
        }

        function startContinuousListening() {
            if (!('webkitSpeechRecognition' in window)) return;
            recognition = new webkitSpeechRecognition();
            recognition.continuous = true; recognition.lang = 'en-US';
            recognition.onend = () => { if(micEnabled) setTimeout(() => { try{recognition.start();}catch(e){} }, 1000); };
            recognition.onresult = (e) => {
                const txt = e.results[e.results.length-1][0].transcript.trim();
                processVoiceInput(txt);
            };
            try { recognition.start(); } catch(e){}
            updateStatusText();
        }

        function processVoiceInput(text) {
            const lower = text.toLowerCase();
            if (isSpeaking) return;
            if (!isAwake) {
                if (lower.includes("jarvis")) {
                    wakeUp();
                    const cmd = lower.split("jarvis")[1];
                    if(cmd && cmd.trim().length > 2) handleChat({key:'Enter', target:{value:cmd.trim()}});
                }
                return;
            }
            resetSilenceTimer();
            if (lower.includes("sleep")) { isAwake = false; updateStatusText(); return; }
            document.getElementById('chat-input').value = text;
            handleChat({key:'Enter', target:{value:text}});
        }

        function wakeUp() { isAwake = true; sfxOpen(); updateStatusText(); resetSilenceTimer(); }
        function resetSilenceTimer() { 
            if(silenceTimer) clearTimeout(silenceTimer); 
            silenceTimer = setTimeout(() => { isAwake = false; updateStatusText(); }, 15000); 
        }
        function updateStatusText() {
            const el = document.getElementById('mic-status');
            if (isAwake) { el.innerText = "LISTENING"; el.classList.add('mic-active'); }
            else { el.innerText = "STANDBY"; el.classList.remove('mic-active'); }
        }
        function testVoice() { speak("Audio systems nominal."); sfxOpen(); }

        async function handleChat(e) {
            if(e.key !== 'Enter') return;
            const msg = e.target.value; if(!msg) return; e.target.value = "";
            const log = document.getElementById('chat-log');
            log.innerHTML += `<br><span style="color:#FFF">> ME:</span> ${msg}`;
            
            const lower = msg.toLowerCase();
            if(lower.includes('config')) { openModal('modal-settings'); return; }
            if(lower.includes('vision')) { toggleVisionMode(); return; }
            if(!userApiKey) { speak("API Key required."); openModal('modal-settings'); return; }

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${userApiKey}`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: msg }] }] })
                });
                const json = await res.json();
                const txt = json.candidates?.[0]?.content?.parts?.[0]?.text;
                if(txt) {
                    log.innerHTML += `<br><span style="color:#00E5FF">> JARVIS:</span> ${txt}`;
                    speak(txt);
                    log.scrollTop = log.scrollHeight;
                }
            } catch(e) { log.innerHTML += `<br><span style="color:red">> ERROR: Network</span>`; }
        }

        // --- DRAWING & TOUCH ---
        window.addEventListener('resize', resize);
        function resize() {
            width = window.innerWidth; height = window.innerHeight;
            canvas.width = width; canvas.height = height;
            centerX = width / 2; centerY = height / 2;
            scale = Math.min(width, height) * 0.40; // Mobile Scale

            const coreSize = (scale * 0.30) * 2; 
            const cv = document.getElementById('core-vision-overlay');
            if(cv && !cv.classList.contains('core-expanded')) {
                cv.style.width = coreSize + 'px';
                cv.style.height = coreSize + 'px';
            }
        }
        resize();

        function handleTouch(e) {
            const t = e.touches ? e.touches[0] : e;
            const rect = canvas.getBoundingClientRect();
            const mx = t.clientX - rect.left - centerX;
            const my = t.clientY - rect.top - centerY;
            const dist = Math.sqrt(mx*mx + my*my);
            const angle = Math.atan2(my, mx);
            
            if (dist > scale * 1.3 && dist < scale * 1.7) {
                for (let item of menuItems) {
                     let diff = angle - item.angle;
                     while(diff < -Math.PI) diff += Math.PI*2; while(diff > Math.PI) diff -= Math.PI*2;
                     if (Math.abs(diff) < 0.4) { openModal(item.targetModal); return; }
                }
            }
        }
        window.addEventListener('touchstart', handleTouch);
        window.addEventListener('mousedown', handleTouch);

        function initAudioEngine() {
            analyser = audioCtx.createAnalyser();
            analyser.fftSize = 64; 
            dataArray = new Uint8Array(analyser.frequencyBinCount);
        }
        function sfxOpen() { 
            try {
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.frequency.value = 600; gain.gain.value = 0.1;
                osc.start(); osc.stop(audioCtx.currentTime + 0.1);
            } catch(e) {}
        }
        function sfxClick() { 
             try {
                 const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                 osc.connect(gain); gain.connect(audioCtx.destination);
                 osc.type = 'square'; osc.frequency.value = 1200; gain.gain.value = 0.05;
                 osc.start(); osc.stop(audioCtx.currentTime + 0.05);
             } catch(e) {}
        }

        function draw() {
            try {
                ctx.setTransform(1,0,0,1,0,0);
                ctx.clearRect(0,0,width,height);
                ctx.translate(centerX, centerY);
                
                let audioData = 0;
                if (analyser && (isAwake || isSpeaking)) {
                    analyser.getByteFrequencyData(dataArray);
                    let sum = 0; for(let i=0; i<dataArray.length; i++) sum += dataArray[i];
                    audioData = (sum / dataArray.length) / 255; 
                }

                // REACTOR MK.III LAYERS
                ctx.save(); ctx.rotate(time * 0.0005); 
                for (let i = 0; i < 60; i++) {
                    ctx.rotate(Math.PI * 2 / 60); ctx.beginPath(); ctx.moveTo(scale*1.0,0); ctx.lineTo(scale*1.1,0);
                    ctx.strokeStyle = colors.cyan; ctx.lineWidth = 1; ctx.stroke();
                }
                ctx.restore();

                ctx.save(); ctx.rotate(-time * 0.001);
                ctx.lineWidth = scale * 0.12; ctx.strokeStyle = 'rgba(0, 229, 255, 0.5)';
                for(let j=0; j<3; j++) {
                    ctx.beginPath(); ctx.arc(0, 0, scale*0.85, 0, 1.2); ctx.stroke(); ctx.rotate(Math.PI*2/3);
                }
                ctx.restore();

                ctx.save(); ctx.rotate(time * 0.002); ctx.strokeStyle = colors.cyan; ctx.lineWidth = 2;
                ctx.beginPath(); ctx.arc(0,0, scale*0.75, 0, Math.PI*2); ctx.stroke(); ctx.restore();

                ctx.save(); ctx.rotate(-time * 0.003); ctx.lineWidth = scale * 0.1; ctx.strokeStyle = colors.cyan;
                for(let l=0; l<2; l++) {
                    ctx.beginPath(); ctx.arc(0,0, scale*0.65, 0, 2.0); ctx.stroke(); ctx.rotate(Math.PI);
                }
                ctx.restore();

                ctx.save(); ctx.rotate(time * 0.01);
                const audioWidth = 6 + (audioData * 30);
                ctx.lineWidth = audioWidth; ctx.strokeStyle = colors.orange; ctx.shadowColor = colors.orange; ctx.shadowBlur = 15;
                ctx.beginPath(); ctx.arc(0,0, scale*0.55, 0, 2.0); ctx.stroke(); ctx.restore();

                ctx.save(); ctx.rotate(time * 0.02);
                ctx.lineWidth = 3; ctx.strokeStyle = colors.white; ctx.shadowColor = colors.white; ctx.shadowBlur = 10;
                ctx.beginPath(); ctx.arc(0,0, scale*0.45, 0, Math.PI*2); ctx.stroke(); ctx.restore();

                // 7. Core (Only draw if Vision is NOT active)
                if (!visionActive) {
                    ctx.save();
                    ctx.fillStyle = colors.cyan; ctx.shadowColor = colors.cyan; ctx.shadowBlur = 40;
                    ctx.globalAlpha = 0.6 + Math.sin(time * 0.05) * 0.2;
                    ctx.beginPath(); ctx.arc(0,0, scale*0.30, 0, Math.PI*2); ctx.fill();
                    
                    ctx.globalAlpha = 1.0; ctx.fillStyle = "#FFFFFF";
                    ctx.font = `bold ${scale * 0.15}px Orbitron`; ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.shadowBlur = 0; ctx.fillText("JARVIS", 0, 0);
                    ctx.restore();
                }

                // ARC BUTTONS
                menuItems.forEach(item => {
                    const r = scale * 1.4;
                    const x = Math.cos(item.angle) * r;
                    const y = Math.sin(item.angle) * r;
                    
                    ctx.beginPath(); ctx.arc(x, y, 25, 0, Math.PI*2); 
                    ctx.fillStyle = "rgba(0, 229, 255, 0.1)"; ctx.fill();
                    ctx.strokeStyle = colors.cyan; ctx.lineWidth = 2; ctx.stroke();

                    ctx.fillStyle = "#FFF"; ctx.font = "10px Orbitron";
                    ctx.textAlign = "center"; ctx.textBaseline = "middle";
                    ctx.fillText(item.label, x, y);
                });

                time++;
                requestAnimationFrame(draw);
            } catch(e) {
                requestAnimationFrame(draw);
            }
        }

        window.addEventListener('load', () => {
            resize();
            draw();
        });
    </script>
</body>
</html>


